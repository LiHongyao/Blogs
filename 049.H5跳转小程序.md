# 前言

最近开发的项目中，遇到一个特殊需求，就是在微信公众号H5中跳转至微信小程序，支付宝生活号（H5）中跳转至支付宝小程序。

# 微信公众号跳转至微信小程序

微信公众号的跳转，查阅了大量的资料，都没有具体的可行性方案，JS-SDK 新增了开放标签 [wx-open-launch-weapp](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_Open_Tag.html)可以实现，但是测试了很多次，遇到了阻碍，而且据官方介绍，需要用户点击按钮触发，这和我们的业务相悖，业务需求是期望能直接跳转。

于是乎我就在思考一个问题，我们可以通过Scheme做APP跳转，那是否微信有官方的 scheme 协议来实现这一需求呢，果不其然，各种Google，发现了微信提供的一个接口协议。

URL Scheme的格式：

```
weixin://dl/business/?ticket=
```

在iOS系统中，系统直接可以识别这种格式 ，但是Android默认不支持，因此一般的做法是统一通过H5页面中转

## #1. 构造HTML

如下构造一个html页面，把这个html部署到服务端生成可外网访问的链接，把这个链接通过短信、邮件等方式发送给目标客户即可（也可以转为短链之后发送），注意在 replace 处替换为你自己的URL Scheme

 ```js
 <!DOCTYPE html>
 <html lang="enzh-CN
   <head>
     <meta charset="UTF-8" />
     <meta http-equiv="X-UA-Compatible" content="IE=edge" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0" />
     <title>跳转小程序</title>
   </head>
   <body>
     <script>
       location.href = "weixin://dl/business/?t=*TICKET*'"; // <!-- replace -->
     </script>
   </body>
 </html>
 ```

**#2. 获取URL Scheme**

参考 [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/url-scheme/urlscheme.generate.html)，获取URL Scheme有 **HTTPS调用**和**云调用**（小程序云开发）两种，这里只说**HTTPS调用**

**① 首先要获取access_token**

https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET

> 注：GET请求，替换你自己的小程序APPID和APPSECRET，直接用postman就可以

**② URL Scheme通过调用如下接口**

https://api.weixin.qq.com/wxa/generatescheme?access_token=ACCESS_TOKEN

> 注：POST请求，需要替换步骤①中获得的access_token

参数示例：

```json
{
  "jump_wxa": {
    "path": "/pages/index/index",
    "query": ""
  },
  "is_expire":true,
  "expire_time":1606737600
}
```

如果你用postman之类的工具调用这个接口时，记得把access_token放在Params部分，把上边的参数示例放在Body中，否则会提示：

```json
{
  "errcode": 44002,
  "errmsg": "empty post data rid: 6013cb37-48dd3dfa-1ee5b3e7"
}
```

如果顺利的话就可以拿到你自己的URL_Scheme了，在#1构造的html中<!-- replace -->部分替换为你的URL_Scheme就可以部署你的html了，然后把可以公网访问的html链接（或转成短链）通过短信、邮件等形式发送给目标就可以了。

> 注意：在微信体系内部是不生效的，只针对微信体系外部有效



## #2. 脚本构造

你可以直接用下边的shell脚本就可以，复制下边的代码，创建并保存到 generate.sh文件中：

```shell

#!/bin/bash
SCHEME_URL="https://api.weixin.qq.com/wxa/generatescheme"
TOKEN_URL="https://api.weixin.qq.com/cgi-bin/token"
APPID="小程序APPID"
SECRET="小程序APPSECRET"
JUMP_PATH="" # 跳转的页面路径 如: pages/index/index
JUMP_QUERY="" # 跳转参数 如要跳转到详情页 如：spuNo=1042087&storeId=3308103
IS_EXPIRE=false # 生成的scheme码类型，到期失效：true，永久有效：false
EXPIRE_TIME=1611912056 # (秒级)到期失效的scheme码的失效时间，为Unix时间戳。生成的到期失效    scheme码在该时间前有效。最长有效期为1年。生成到期失效的scheme时必填。
    
function getToken() {
  RES=`curl -slient -X GET ${TOKEN_URL}'?grant_type=client_credential&appid='${APPID}'&secret='${SECRET}`
  TK=${RES#*access_token\"\:\"}
  TK=${TK%%\"*}
  echo ${TK}
}

TOKEN=`getToken`
function generateURLScheme() {
  SCHEME=`curl -s -X POST -d '{"jump_wxa":{"path":"'${JUMP_PATH}'","query":"'${JUMP_QUERY}'"},"is_expire":'${IS_EXPIRE}',"expire_time": '${EXPIRE_TIME}'}' ${SCHEME_URL}?access_token=${TOKEN}`
  SCHEME=${SCHEME#*openlink\"\:\"}
  SCHEME=${SCHEME%%\"*}
  SCHEME=${SCHEME//\\/} # 把所有的 \ (转义后是//) 替换为空
  echo $SCHEME
}

URL_SCHEME=`generateURLScheme`
echo 'URL_SCHEME：'$URL_SCHEME
HTML_CONTENT='<html><head><meta charset="utf-8"><metaname="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"><title>微信外部跳转到微信并拉起小程序</title><style>html,body{height: 100%; padding: 0px; margin: 0px;}</style></head><body><div style="width: 100%;height: 100%; justify-content: center; align-items: center; display: flex;"><h1><a href="javascript:void(0);" onclick="jumpToMp()">点我跳转到微信小程序</a></h1></div></body><script>function jumpToMp(){window.location.href="'$URL_SCHEME'"}jumpToMp()</script></html>'

echo '' > scheme_html.html
echo $HTML_CONTENT >> scheme_html.html
echo scheme_html.html文件已生成
```

最后在终端执行：

```shell
$ chmod +x ./generate.sh && sh ./generate.sh
```

把输出的scheme_html.html部署到服务端即可



# 支付宝生活号（H5）跳转至支付宝小程序

