# 一、前言

现如今，为了减少带宽，降低服务器压力，图片上传一般由前端直传至云服务器（七牛云、阿里云、腾讯等等）。

本文主要总结在开发中用到的图片上传方式，不限语言框架，随意总结，只是希望能给到大家一个思路，举一反三。

# 二、上传七牛云

**文档地址：**[七牛云 JavaScript SDK 文档 >>](https://developer.qiniu.com/kodo/1283/javascript)

**使用框架：**`React + TS`

**视图组件：**[Ant Design Mobile](https://mobile.ant.design/index-cn)

**试用环境：**微信公众号

> 视图

```tsx
import React, { useState } from 'react';
import { ImagePicker, Toast } from 'antd-mobile';
import Api from '@/Api';
import Tools from 'lg-tools';

interface FormDataProps {
  logo: string;
}

const Page: React.FC = () => {
  // state
  const [formData, setFormData] = useState<FormDataProps>({
    logo: '',
  });

  // methods
  // 图片预览：微信环境直接使用JS-SDK/previewImage
  const previewImage = (i: number | undefined, files: string[] | undefined) => {
    window.wx.previewImage({
      current: files && files[i || 0], // 当前显示图片的http链接
      urls: files, // 需要预览的图片http链接列表
    });
  };
    
  // events
  const onImagePickerChangeHandle = (
    files: { url: string; file?: any }[],
    type: string,
  ) => {
    // 如果files 不存在或者长度为0，则移除数据
    if (files && files.length === 0) {
      setFormData(prev => Tools.deepUpdate(prev, type, '') as FormDataProps);
      return;
    }
      
    // 尺寸判断
    if (files[0].file.size > 10 * 1024 * 1024) {
      Toast.info('上传图片不能超过10M！');
      return;
    }
      
    Toast.loading('文件上传中...', 1000000);
    
    // 从后端服务获取上传token（后端开发者处理）
    Api.bd
      .uploadToken<BD.BaseResponse<{ key: string; uploadToken: string }>>({
        fileName: files[0].file.name,
      })
      .then(res => {
        if (res?.code === 0) {
          const { key, uploadToken } = res.data;
          // 拼接formdata
          const _ = new FormData();
          _.append('file', files[0].file);
          _.append('key', key);
          _.append('token', uploadToken);
          // 执行上传
          fetch('https://upload.qiniup.com', {
            method: 'POST',
            body: _,
          })
            .then(async response => {
              const res = await response.clone().json();
              // 更新数据
              setFormData(prev => Tools.deepUpdate(prev, type, res.key) as FormDataProps);
            })
            .finally(() => {
              Toast.hide();
            });
        } else {
          Toast.hide();
        }
      })
      .catch(() => {
        Toast.hide();
      });
  };

  return (
    <div className="page">
      <ImagePicker
        selectable={!formData.logo}
        length={1}
        onImageClick={(i, files) =>
          // 点击图片时，预览
          previewImage(
            i,
            files?.map(el => el.url),
          )
        }
        // 回显
        files={formData.logo ? [{ url: formData.logo }] : []}
        // 文件change时执行上传逻辑
        onChange={files => {
          onImagePickerChangeHandle(files, 'logo');
        }}
      />
    </div>
  );
};

export default Page;
```

提示：[lg-tools](https://www.npmjs.com/package/lg-tools).deepUpdate 是我封装的一个方法，支持以namePath的形式修改对象值。

> 样式

```less
.am-image-picker-list {
  padding: 0;
  margin-bottom: 0;
  .am-image-picker-upload-btn {
    border: none;
    background: url('../../assets/images/icon-check-image.png') center
      center/cover no-repeat;
    &:before {
      display: none;
    }
    &:after {
      display: none;
    }
  }
}
.am-image-picker {
  width: 80px;
  height: 80px;
}
```

# 三、上传OSS

**参考地址：**[Web端上传数据至OSS >>](https://help.aliyun.com/document_detail/31926.html)  & [后端前面/前端直传 >>](https://blog.anyway.work/2020/03/26/AliyunOSS%E5%89%8D%E7%AB%AF%E7%9B%B4%E4%BC%A0/)

**使用框架：**`React + ts`

**场景介绍：**该案例主要应用在后台管理系统开发中，由于图片上传多出现在表单，所以视图部分代码（核心代码）如下：

```tsx
<Form.Item noStyle shouldUpdate={() => true}>
  {({ getFieldValue }) => {
    const avatar = getFieldValue('avatar');
    return (
      <Form.Item
        name="avatar"
        label="头像"
        required
        rules={[
          {
            validator: (ruls: RuleObject, value: any) => {
              if (!value) {
                return Promise.reject('请上传头像');
              }
              return Promise.resolve();
            },
          },
        ]}
      >
        <ImagePicker
          urls={avatar ? [avatar] : []}
          onFileChange={(files: FileList | null) =>
            uploadImage(files, 'avatar')
          }
          onDelete={(index) => {
            addForm.setFieldsValue({
              avatar: '',
            });
          }}
        />
      </Form.Item>
    );
  }}
</Form.Item>
```

**ImagePicker** 是我自己封装的一个组件，组件代码如下：

```tsx
// --- ImagePicker/index.tsx
import React, { ChangeEvent, memo } from 'react';
import { Image } from 'antd';
import { PlusOutlined, CloseCircleOutlined } from '@ant-design/icons';

import './index.less';

interface IProps {
  urls: string[];
  max?: number;
  width?: number;
  height?: number;
  disabled?: boolean;
  onFileChange: (files: FileList | null) => void;
  onDelete: (index: number) => void;
}
const ImagePicker: React.FC<IProps> = (props) => {
  const { urls, max = 1, disabled = false, width = 80, height = 80 } = props;
  const onFileChange = (e: ChangeEvent<HTMLInputElement>) => {
    if (disabled) return;
    props.onFileChange(e.target.files);
  };
  return (
    <div className="lg-img-picker">
      {urls.map((url, index) => (
        <div
          className="lg-img-picker__item"
          key={url}
          style={{ width, height }}
        >
          <Image src={url} style={{ width: '100%', height: '100%' }} />
          <CloseCircleOutlined
            className="close"
            onClick={() => {
              if (disabled) return;
              props.onDelete(index);
            }}
          />
        </div>
      ))}
      {urls.length < max ? (
        <div
          className="lg-img-picker__item upload-btn"
          style={{ width, height }}
        >
          <input type="file" onChange={onFileChange} />
          <PlusOutlined style={{ color: '#A9A9A9' }} />
        </div>
      ) : null}
    </div>
  );
};

export default memo(ImagePicker);

```

```less
// --- ImagePicker/index.less
.lg-img-picker {
  display: flex;
  flex-wrap: wrap;
  &__item {
    background: #f5f5f5;
    border: 1px solid #a9a9a9;
    padding: 2px;
    margin-right: 10px;

    display: flex;
    justify-content: center;
    align-items: center;

    position: relative;
    &.upload-btn {
      border: 1px dashed #a9a9a9;
    }

    .close {
      font-size: 18px;
      position: absolute;
      right: -8px;
      top: -8px;
      color: #a9a9a9;
      cursor: pointer;
    }
    .ant-image {
      width: 100%;
      height: 100%;
    }
    input {
      width: 100%;
      height: 100%;
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
    }
  }
}

```

重点在uploadImgae方法里面：

```js
/**
 * 上传图片
 * @param files 文件对象
 * @param key   存储key
 * @returns
 */
const uploadImage = (files: FileList | null, key: string) => {
  // 判断文件对象是否存在
  if (files && files[0]) {
    const file = files[0];
    // 校验
    if (!/^.+(jpe?g)|(png)$/i.test(file.name)) {
      message.info('只支持上传jpg、jpeg、png格式的图标！');
      return;
    }
    // 上传图片不能超过2MB
    const isLt2M = file.size / 1024 / 1024 < 2;
    if (!isLt2M) {
      message.info('上传图片不能超过2MB');
      return;
    }

    message.loading('上传中...', 20);

    // filename
    const filename = Tools.getFilePath(file, 'lovePets/admin/roles-avatar');
    // 调用后端接口获取OSSConfigs配置信息
    Api.oss
      .getConfigs<HT.BaseResponse<HT.OSSResponseType>>()
      .then(async (res) => {
        if (res && res.status === 200) {
          const client = new OSS({
            bucket: 'heart-tours',
            region: 'oss-cn-shenzhen',
            endpoint: 'oss-cn-shenzhen.aliyuncs.com',
            accessKeyId: res.data.Credentials.AccessKeyId,
            accessKeySecret: res.data.Credentials.AccessKeySecret,
            stsToken: res.data.Credentials.SecurityToken,
            // refreshSTSToken: ,
          });
          const result = await client.put(filename, file);
          addForm.setFieldsValue({
            avatar: result.url,
          });
        }
      });
  }
};
```

