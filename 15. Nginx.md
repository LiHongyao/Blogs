# ä¸€ã€æ¦‚è¿°

Nginxæ˜¯ä¸€æ¬¾æ˜¯ç”±ä¿„ç½—æ–¯çš„ç¨‹åºè®¾è®¡å¸ˆIgor Sysoevæ‰€å¼€å‘é«˜æ€§èƒ½çš„ Webå’Œ åå‘ä»£ç† æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª IMAP/POP3/SMTP ä»£ç†æœåŠ¡å™¨ã€‚åœ¨é«˜è¿æ¥å¹¶å‘çš„æƒ…å†µä¸‹ï¼ŒNginxæ˜¯ApacheæœåŠ¡å™¨ä¸é”™çš„æ›¿ä»£å“ã€‚

# äºŒã€å®‰è£…

## 1. macOS

```shell
$ brew install nginx
...
==> Pouring nginx-1.17.9.catalina.bottle.tar.gz
==> Caveats
Docroot is: /usr/local/var/www

The default port has been set in ã€/usr/local/etc/nginx/nginx.confã€‘ to 8080 so that
nginx can run without sudo.

nginx will load all files in /usr/local/etc/nginx/servers/.

To have launchd start nginx now and restart at login:
  brew services start nginx
Or, if you don't want/need a background service you can just run:
  nginx
==> Summary
ğŸº  /usr/local/Cellar/nginx/1.17.9: 25 files, 2.1MB
...
$ nginx -v
nginx version: nginx/1.17.8
$ sudo nginx
```

æµè§ˆå™¨è¾“å…¥ï¼š*localhost:8080* å¦‚æœå‡ºç°å¦‚ä¸‹é¡µé¢ï¼Œå¯åŠ¨æˆåŠŸï¼

![](IMGS/welcome-nginx.png)

>  æç¤ºï¼š8080æ˜¯nginxè‡ªå¸¦çš„é»˜è®¤ç½‘ç«™è®¾ç½®çš„ç«¯å£

## 2. Windows

å‚è€ƒæŒ‡å—ï¼šhttp://nginx.org/en/docs/windows.html

# ä¸‰ã€é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶ï¼š/usr/local/etc/nginx/nginx.conf   & /usr/local/etc/nginx/nginx.conf.default

å…¶ä¸­ ngin.conf.default ç±»ä¼¼äºå¤‡ä»½æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦é…ç½® /usr/local/etc/nginx/nginx.conf æ–‡ä»¶å³å¯ã€‚

# å››ã€ä»£ç†

ä»€ä¹ˆæ˜¯ä»£ç†ï¼Ÿæ¯”å¦‚æˆ‘ç°åœ¨æƒ³åƒä¸€åªç‚¸é¸¡ï¼Œä½†æ˜¯æˆ‘åˆä¸æƒ³è‡ªå·±å‡ºé—¨å»ä¹°ï¼Œäºæ˜¯æˆ‘å°±å«äº†ä¸ªè·‘è…¿æœåŠ¡ï¼Œè®©è·‘è…¿çš„å»ç»™æˆ‘ä¹°ï¼Œè¿™é‡Œï¼Œè·‘è…¿çš„å°±æˆä¸ºäº†æˆ‘çš„ä»£ç†ã€‚

ä»£ç†ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¦‚æœæˆ‘ä»¬æƒ³åšä»€ä¹ˆï¼Œä½†åˆä¸æƒ³ç›´æ¥å»åšï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±æ‰¾å¦å¤–ä¸€ä¸ªäººå¸®æˆ‘ä»¬å»åšã€‚é‚£ä¹ˆåœ¨è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œè·‘è…¿çš„å°±æ˜¯ä¸“é—¨åšä»£ç†æœåŠ¡çš„ã€‚

Nginx ä¸»è¦èƒ½å¤Ÿä»£ç†å¦‚ä¸‹å‡ ç§åè®®ï¼Œå…¶ä¸­ç”¨åˆ°çš„æœ€å¤šçš„å°±æ˜¯åšHttpä»£ç†æœåŠ¡å™¨ã€‚

![](./IMGS/nginx-proxy.png)

## 1. æ­£å‘ä»£ç†

ä¸¾ä¸€ä¸ªä¾‹å­å¸®åŠ©å¤§å®¶ç†è§£æ­£å‘ä»£ç†ï¼Œå¤§å®¶éƒ½çŸ¥é“ï¼Œç°åœ¨å›½å†…æ˜¯è®¿é—®ä¸äº† YouTube çš„ï¼Œé‚£ä¹ˆæ€ä¹ˆæ‰èƒ½è®¿é—® YouTube å‘¢ï¼Ÿæˆ‘ä»¬åˆæƒ³ï¼Œç¾å›½äººä¸æ˜¯èƒ½è®¿é—® YouTube å—ï¼ˆè¿™ä¸åºŸè¯ï¼ŒYouTube å°±æ˜¯ç¾å›½çš„ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬ç”µè„‘çš„å¯¹å¤–å…¬ç½‘ IP åœ°å€èƒ½å˜æˆç¾å›½çš„ IP åœ°å€ï¼Œé‚£ä¸å°±å¯ä»¥è®¿é—® YouTubeäº†ï¼Ÿã€‚VPN å°±æ˜¯è¿™æ ·äº§ç”Ÿçš„ã€‚æˆ‘ä»¬åœ¨è®¿é—® YouTube æ—¶ï¼Œå…ˆè¿ä¸Š VPN æœåŠ¡å™¨å°†æˆ‘ä»¬çš„ IP åœ°å€å˜æˆç¾å›½çš„ IP åœ°å€ï¼Œç„¶åå°±å¯ä»¥é¡ºåˆ©çš„è®¿é—®äº†ã€‚

è¿™é‡Œçš„ VPN å°±æ˜¯åšæ­£å‘ä»£ç†çš„ã€‚æ­£å‘ä»£ç†æœåŠ¡å™¨ä½äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œä¸ºäº†å‘æœåŠ¡å™¨è·å–æ•°æ®ï¼Œå®¢æˆ·ç«¯è¦å‘ä»£ç†æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶æŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å°†ç›®æ ‡æœåŠ¡å™¨è¿”å›çš„æ•°æ®è½¬äº¤ç»™å®¢æˆ·ç«¯ã€‚è¿™é‡Œå®¢æˆ·ç«¯æ˜¯è¦è¿›è¡Œä¸€äº›æ­£å‘ä»£ç†çš„è®¾ç½®çš„ã€‚

PSï¼šVPN é€šä¿—çš„è®²å°±æ˜¯ä¸€ç§ä¸­è½¬æœåŠ¡ï¼Œå½“æˆ‘ä»¬ç”µè„‘æ¥å…¥ VPN åï¼Œæˆ‘ä»¬å¯¹å¤– IP åœ°å€å°±ä¼šå˜æˆ VPN æœåŠ¡å™¨çš„ å…¬ç½‘ IPï¼Œæˆ‘ä»¬è¯·æ±‚æˆ–æ¥å—ä»»ä½•æ•°æ®éƒ½ä¼šé€šè¿‡è¿™ä¸ªVPN æœåŠ¡å™¨ç„¶åä¼ å…¥åˆ°æˆ‘ä»¬æœ¬æœºã€‚è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿæ¯”å¦‚ VPN æ¸¸æˆåŠ é€Ÿæ–¹é¢çš„åŸç†ï¼Œæˆ‘ä»¬è¦ç©ç½‘é€šåŒºçš„ LOLï¼Œä½†æ˜¯æœ¬æœºæ¥å…¥çš„æ˜¯ç”µä¿¡çš„å®½å¸¦ï¼Œç©ç½‘é€šåŒºçš„ä¼šæ¯”è¾ƒå¡ï¼Œè¿™æ—¶å€™å°±åˆ©ç”¨ VPN å°†ç”µä¿¡ç½‘ç»œå˜ä¸ºç½‘é€šç½‘ç»œï¼Œç„¶ååœ¨ç©ç½‘é€šåŒºçš„LOLå°±ä¸ä¼šå¡äº†ï¼ˆæ³¨æ„ï¼šVPN æ˜¯ä¸èƒ½å¢åŠ å¸¦å®½çš„ï¼Œä¸è¦ä»¥ä¸ºä¸å¡äº†æ˜¯å› ä¸ºç½‘é€Ÿæå‡äº†ï¼‰ã€‚

## 2. åå‘ä»£ç†

åå‘ä»£ç†å’Œæ­£å‘ä»£ç†çš„åŒºåˆ«å°±æ˜¯ï¼š

- **æ­£å‘ä»£ç†ä»£ç†å®¢æˆ·ç«¯**ï¼šæˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç«¯è¿›è¡Œä¸€äº›ä»£ç†çš„è®¾ç½®
- **åå‘ä»£ç†ä»£ç†æœåŠ¡å™¨ï¼š**ä½œä¸ºå®¢æˆ·ç«¯çš„æˆ‘ä»¬æ˜¯æ— æ³•æ„ŸçŸ¥åˆ°æœåŠ¡å™¨çš„çœŸå®å­˜åœ¨çš„

åå‘ä»£ç†ï¼Œå…¶å®å®¢æˆ·ç«¯å¯¹ä»£ç†æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¸éœ€è¦ä»»ä½•é…ç½®å°±å¯ä»¥è®¿é—®ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¯·æ±‚å‘é€åˆ°åå‘ä»£ç†æœåŠ¡å™¨ï¼Œç”±åå‘ä»£ç†æœåŠ¡å™¨å»é€‰æ‹©ç›®æ ‡æœåŠ¡å™¨è·å–æ•°æ®åï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶åå‘ä»£ç†æœåŠ¡å™¨å’Œç›®æ ‡æœåŠ¡å™¨å¯¹å¤–å°±æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæš´éœ²çš„æ˜¯ä»£ç†æœåŠ¡å™¨åœ°å€ï¼Œéšè—äº†çœŸå®æœåŠ¡å™¨IPåœ°å€ã€‚

# äº”ã€Nginx åå‘ä»£ç†

ç¤ºä¾‹ï¼šä½¿ç”¨ nginx åå‘ä»£ç† www.123.com ç›´æ¥è·³è½¬åˆ°http://www.baidu.comã€‚

## 1. åŸŸåç»‘å®š

é€šè¿‡ä¿®æ”¹ hosts æ–‡ä»¶ï¼Œç»‘å®šåŸŸåï¼ŒæŒ‡ä»¤å¦‚ä¸‹ï¼š

```shell
$ sudo vim /private/etc/hosts
```

æŒ‰ `i` è¿›å…¥ç¼–è¾‘æ¨¡å¼åœ¨æœ€åä¸€è¡Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```ini
127.0.0.1   www.123.com
```

æŒ‰ `esc` é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œç„¶åè¾“å…¥ `:wq!` ä¿å­˜é€€å‡ºå³å¯ï¼Œåˆ°è¿™é‡Œå°±å®Œæˆäº†åŸŸåç»‘å®šï¼Œå°†â€œwww.123.comâ€ æ˜ å°„åˆ° â€œ127.0.0.1â€ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ç»ˆç«¯  ping ä¸€ä¸‹è¿™ä¸ªåŸŸåï¼Œå¦‚æœè®¿é—®çš„ ip æ˜¯ â€œ127.0.0.1â€ å°±è¯´æ˜åŸŸåæ˜ å°„æˆåŠŸï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ ping www.123.com
PING lihy.com (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.040 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.061 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.094 ms
64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.108 ms
...
```

## 2. è½¬å‘

åŸŸåç»‘å®šæˆåŠŸä¹‹åï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨è¾“å…¥ â€œhttp://www.123.comâ€ è®¿é—®ï¼Œå‡ºç°â€œ404 Not Foundâ€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨nginx é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š

```ini
server {
    listen 80;
    server_name www.123.com;
    location / {   
        # æŠŠè¯·æ±‚è½¬å‘åˆ°ç™¾åº¦
        proxy_pass  https://www.baidu.com;
    }
}
```

å¦‚ä¸Šé…ç½®ï¼Œæˆ‘ä»¬ç›‘å¬80ç«¯å£ï¼Œè®¿é—®åŸŸåä¸º www.123.comï¼Œä¸åŠ ç«¯å£å·æ—¶é»˜è®¤ä¸º80ç«¯å£ï¼Œæ•…è®¿é—®è¯¥åŸŸåæ—¶ä¼šè·³è½¬åˆ° https://www.baidu.com è·¯å¾„ä¸Šã€‚

ä¿å­˜é…ç½®æ–‡ä»¶å¹¶é‡å¯nginxï¼š

```shell
$ sudo nginx -s reload
```

å›åˆ°æµè§ˆå™¨ï¼Œé‡æ–°è®¿é—® â€œhttp://www.123.com"ï¼Œå³å¯çœ‹åˆ°ç™¾åº¦é¡µé¢ã€‚

å¦‚æœè¦æ˜ å°„æœ¬åœ°ç½‘ç«™è·¯å¾„ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

```ini
server {
    listen 80;
    server_name www.123.com;
    location / {   
        #æœ¬åœ°ç½‘ç«™æ–‡ä»¶å¤¹è·¯å¾„
        root   /Users/lihongyao/WebSites;
        #è®¾ç½®é»˜è®¤ç½‘é¡µ
        index  index.html index.htm;
    }
}
```

## 3. ä»£ç†æœåŠ¡å™¨

å®¢æˆ·ç«¯ï¼šhttp://127.0.0.1:5500

```js
fetch('/api/infos')
.then(response => response.json())
.then(data => {
    console.log(data);
})
```

æœåŠ¡ç«¯ï¼šhttp://127.0.0.1:3000

```js
// => å¯¼å…¥æ¨¡å—
const Koa = require('koa'); 
const router = require('./router');
const app = new Koa();

// => å¤„ç†è·¯ç”±
router.get('/api/infos', async (ctx) => {
	ctx.body = JSON.stringify({
		name: 'Muzili',
		tel: '17398888669'
	})
});
app.use(router.routes()).use(router.allowedMethods());

// => ç›‘å¬
app.listen(3000, () => {
	console.log('server running at http://localhost:3000');
});
```

Nginx é…ç½®æ–‡ä»¶

```ini
http {
    listen 80;
    server_name  www.123.com;
    server {
        location / {
            proxy_pass  http://127.0.0.1:5500;
            # å…¼å®¹websocket
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        location /api/ {
           proxy_pass http://localhost:3000;
        }
    }
}
```

# å…­ã€è´Ÿè½½å‡è¡¡

Lvs ä¸ nginx åŒºåˆ«

# ä¸ƒã€äºŒçº§ç›®å½•éƒ¨ç½²

## 1. éƒ¨ç½²å¤šé¡µé¡¹ç›®

åœ¨éƒ¨ç½²é¡¹ç›®è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªåŸŸåä¸‹å¯èƒ½ä¼šéƒ¨ç½²å¤šä¸ªé¡¹ç›®ï¼Œæ¯”å¦‚åœ¨æ ¹ç›®å½•ä¸­æœ‰ä¸ª /test é¡¹ç›®ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```ini
location /test {
    alias  /usr/local/etc/nginx/servers/test;
    index  index.html index.htm;
}
```

# 2. éƒ¨ç½²Reactå•é¡µé¡¹ç›®

**nginx é…ç½®ï¼š**

```ini
location /pre-dtree-h5 {
  alias   /usr/local/etc/nginx/servers/pre-dtree-h5/;
  index  index.html index.htm;
  try_files $uri $uri/ /pre-dtree-h5/index.html;
}
```

**react é¡¹ç›®é…ç½®ï¼š**

é¦–å…ˆåœ¨package.jsonä¸­æ·»åŠ ï¼š`"homepage":"/pre-dtree-h5"`

ç„¶ååœ¨reactè·¯ç”±ä¸­é…ç½®basenameå±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```jsx
<Router basename="/pre-dtree-h5">
  <div className="App">
    {/* è·¯ç”±é…ç½® */}
    <Switch>
    	{renderRoutes(routes)}
    </Switch>
  </div>
</Router>
```

> æç¤ºï¼š`pre-dtree-h5` ä¸ºé¡¹ç›®åç§°ï¼Œä½ å¯ä»¥æ›¿æ¢æˆä½ è‡ªå·±çš„ã€‚

# å…«ã€å¼‚å¸¸å¤„ç†

**# 48: Address already in use**

**\> åŸå› ï¼š**

80ç«¯å£å·²è¢«å ç”¨(å¯èƒ½å› ä¸ºæœªæˆåŠŸå…³é—­ä¸€äº›æœåŠ¡,å¦‚nginxæœåŠ¡ç­‰)

**\> è§£å†³ï¼š**

1. sudo nginx -s stop(æˆ–è€…:sudo nginx -s quit)ï¼Œç„¶åé‡æ–°å¯åŠ¨(sudo nginx)ã€‚
2. å¦‚æœæ˜¯å…¶ä»–æœåŠ¡å ç”¨ç«¯å£ï¼Œåˆ™å…³é—­å…¶ä»–æœåŠ¡ï¼Œæˆ–è€…ä¿®æ”¹nginxé…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£ã€‚

# ä¹ã€å¸¸ç”¨æŒ‡ä»¤

| æŒ‡ä»¤              | æè¿°               |
| ----------------- | ------------------ |
| `ngin`            | å¯åŠ¨               |
| `nginx -s quit`   | é€€å‡º               |
| `nginx -s reload` | é‡è½½               |
| `nginx -t`        | æµ‹è¯•nginx.confé…ç½® |







 



























