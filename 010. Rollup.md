

# ä¸€ã€æ¦‚è¿°

[Rollup >>](https://cn.rollupjs.org/) æ˜¯ä¸€ä¸ªé¢å‘ç°ä»£jsåº”ç”¨çš„æ¨¡å—æ‰“åŒ…å·¥å…·ï¼Œä¸“æ³¨äºåˆ›å»ºç”¨äºåº“å’Œç±»ä¼¼åº“çš„æ‰“åŒ…ã€‚

å…·å¤‡ä»¥ä¸‹è¿™äº›ç‰¹ç‚¹ï¼š

- é‡‡ç”¨ESæ¨¡å—ä½œä¸ºæ ‡å‡†ï¼Œå¯ä»¥æŒ‰éœ€å¼•å…¥å’Œæ‰“åŒ…ä»£ç ï¼Œå¹¶ä¸”èƒ½å¤Ÿè¿›è¡Œ **Tree Shaking**ï¼Œå»é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œå‡å°è¾“å‡ºæ–‡ä»¶å¤§å°ã€‚
- ç›¸å¯¹äº Webpackï¼ŒRollup æ›´åŠ è½»é‡çº§å’Œç®€å•ï¼Œå®ƒä¸æä¾›åƒWebpacké‚£æ ·ä¸°å¯Œçš„æ’ä»¶å’ŒåŠ è½½å™¨ç”Ÿæ€ç³»ç»Ÿï¼Œä½†å®ƒçš„è¾“å‡ºæ›´ç²¾ç®€ã€‚

Webpack ğŸ†š Rollupï¼š

æ‰“åŒ…ç­–ç•¥ï¼š

- Rollup çš„ä¸»è¦ç›®æ ‡æ˜¯ç”Ÿæˆæ›´å°ã€æ›´ç²¾ç®€çš„ä»£ç åŒ…ã€‚å®ƒé€šè¿‡é™æ€åˆ†æå’ŒTree Shakingç­‰æŠ€æœ¯ï¼Œå°†ä»£ç æ¨¡å—æŒ‰éœ€æ‰“åŒ…ï¼Œæ¶ˆé™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œä»¥å‡å°æœ€ç»ˆç”Ÿæˆçš„åŒ…çš„ä½“ç§¯ã€‚
- Webpackåˆ™æ›´æ³¨é‡äºå¤„ç†å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼Œæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½å’Œæ’ä»¶ç”Ÿæ€ç³»ç»Ÿã€‚å®ƒå¯ä»¥å¤„ç†å„ç§ç±»å‹çš„èµ„æºï¼ˆå¦‚JavaScriptã€CSSã€å›¾ç‰‡ç­‰ï¼‰ï¼Œæ”¯æŒä»£ç æ‹†åˆ†ã€æŒ‰éœ€åŠ è½½ã€åŠ¨æ€å¯¼å…¥ç­‰ç‰¹æ€§ï¼Œä»¥åŠæ›´å¤æ‚çš„é…ç½®é€‰é¡¹ã€‚

é™æ€å’ŒåŠ¨æ€åˆ†æï¼š

- Rollupåœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­ä½¿ç”¨é™æ€åˆ†æï¼Œå³åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šæ¨¡å—çš„ä¾èµ–å…³ç³»ã€‚
- Webpacké‡‡ç”¨åŠ¨æ€åˆ†æï¼Œå³åœ¨è¿è¡Œæ—¶æ ¹æ®æ¨¡å—åŠ è½½çš„æƒ…å†µæ¥ç¡®å®šä¾èµ–å…³ç³»ã€‚

ç”Ÿæ€ç³»ç»Ÿå’Œæ’ä»¶æ”¯æŒï¼š

- Webpack æ‹¥æœ‰åºå¤§çš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œæä¾›äº†ä¸°å¯Œçš„æ’ä»¶å’ŒåŠ è½½å™¨ï¼Œå¯ä»¥å¤„ç†å„ç§èµ„æºç±»å‹ï¼Œä»¥åŠæä¾›äº†è®¸å¤šæ‰©å±•åŠŸèƒ½ï¼ˆå¦‚çƒ­æ¨¡å—æ›¿æ¢ã€ä»£ç åˆ†å‰²ç­‰ï¼‰ã€‚
- Rollupçš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿç›¸å¯¹è¾ƒå°ï¼Œä½†ä¹Ÿæä¾›äº†ä¸€äº›å¸¸ç”¨çš„æ’ä»¶å’ŒåŠŸèƒ½ã€‚

> æ¯”è¾ƒä¸åŒæ‰“åŒ…å·¥å…·çš„åŒºåˆ«ï¼š [å‚è€ƒèµ„æ–™ï¼šOverview | Tooling.Report](https://bundlers.tooling.report/)

ä½¿ç”¨åœºæ™¯ï¼š

- Webpack é€‚åˆç”¨åœ¨é¡¹ç›®ä¸­
- Rollup é€‚ç”¨äºå¼€å‘ä¸€äº›å·¥å…·åº“ã€ç»„ä»¶åº“

# äºŒã€é…ç½®æ–‡ä»¶

**`rollup.config.js`**

```js
import { defineConfig } from 'rollup';

export default defineConfig({
  input,
  output,
  plugins,
  watch,
  external,
  cache,
});
```

- `input`ï¼šå…¥å£æ–‡ä»¶ï¼Œrollup å°†ä»è¿™é‡Œå»æ‰«æè§£æä»£ç ï¼Œç”Ÿæˆä»£ç ä¾èµ–æ ‘ï¼Œæ”¯æŒå¤šä¸ª
- `output`ï¼šè¾“å‡ºé…ç½®é¡¹ï¼Œä¸»è¦æ˜¯æŒ‡ç¼–è¯‘è¾“å‡ºä»€ä¹ˆæ ¼å¼çš„ä»£ç 
- `plugins`ï¼šæ’ä»¶é…ç½®
- `watch`ï¼šæ–‡ä»¶ç›‘å¬
- `external`ï¼šå¿½ç•¥æ‰“åŒ…æ¨¡å—åˆ—è¡¨ï¼Œå¦‚ï¼šæœ‰äº›å…¬å…±åº“ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ„å»ºè¿›æ¥
- `cache`ï¼šæ„å»ºç¼“å­˜ï¼Œæ˜¯å¦å¼€å¯æ„å»ºç¼“å­˜ï¼Œæé«˜æ„å»ºé€Ÿåº¦ï¼Œä¾æ®é…ç½®å†…å®¹å¯ä»¥æ‰å»ä¸åŒç¼“å­˜ç­–ç•¥

> æç¤ºï¼šæœ‰å…³æ¯ä¸ªé€‰é¡¹çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [é€‰é¡¹å¤§å…¨ >>](https://cn.rollupjs.org/configuration-options/)

# ä¸‰ã€å¸¸ç”¨Plugins

- [rollup](https://www.npmjs.com/package/rollup)ï¼šæ ¸å¿ƒåº“

- [cross-env](https://www.npmjs.com/package/cross-env)ï¼šè·¨ç¯å¢ƒè®¾ç½®ç¯å¢ƒå˜é‡

- [@rollup/plugin-commonjs](https://www.npmjs.com/package/@rollup/plugin-commonjs)ï¼šæ”¯æŒå¯¼å…¥ cjs æ¨¡å—

- [@rollup/plugin-json](https://www.npmjs.com/package/@rollup/plugin-json)ï¼šæ”¯æŒç›´æ¥ä»jsonæ–‡ä»¶ä¸­è¯»å–æ•°æ®

- [@rollup/plugin-node-resolve](https://www.npmjs.com/package/@rollup/plugin-node-resolve)ï¼šå¼•å…¥å¤–éƒ¨èµ„æºï¼Œè§£æç¬¬ä¸‰æ–¹æ¨¡å—çš„ä¾èµ–å…³ç³» â€”â€” *(!) Unresolved dependencies*

- [@rollup/plugin-alias](https://www.npmjs.com/package/@rollup/plugin-alias)ï¼šè·¯å¾„åˆ«å

- [rollup-plugin-delete](https://www.npmjs.com/package/rollup-plugin-delete)ï¼šæ¯æ¬¡æ‰“åŒ…ä¹‹å‰æ¸…é™¤è¾“å‡ºç›®å½•ï¼ˆdelï¼‰

- [@rollup/plugin-terser](https://www.npmjs.com/package/@rollup/plugin-terser)ï¼šä»£ç å‹ç¼©

- [@rollup/plugin-eslint](https://www.npmjs.com/package/@rollup/plugin-eslint)ï¼šEslintä»£ç æ£€æµ‹

- [@rollup/plugin-replace](https://www.npmjs.com/package/@rollup/plugin-replace)ï¼šåœ¨ Rollup æ‰“åŒ…è¿‡ç¨‹ä¸­æ›¿æ¢ä»£ç ä¸­çš„å­—ç¬¦ä¸²æˆ–è¡¨è¾¾å¼ï¼ˆå¦‚ç¯å¢ƒå˜é‡ã€é…ç½®å‚æ•°ç­‰ï¼‰

- [rollup-plugin-generate-package-json](https://www.npmjs.com/package/rollup-plugin-generate-package-json)ï¼šç”Ÿæˆ package.json æ–‡ä»¶

- [rollup-plugin-filesize](https://www.npmjs.com/package/rollup-plugin-filesize)ï¼šæŸ¥çœ‹æ‰“åŒ…ä¹‹åçš„æ–‡ä»¶å¤§å°

  

- [@rollup/plugin-babel](https://www.npmjs.com/package/@rollup/plugin-babel)ï¼šç”¨äºä½¿ç”¨ Babel è¿›è¡Œè½¬è¯‘

- [@babel/core](https://www.npmjs.com/package/@babel/core)ï¼šBabel æ ¸å¿ƒåº“

- [@babel/preset-env](https://www.npmjs.com/package/@babel/preset-env)ï¼šBabel é¢„è®¾é…ç½®

- [core-js](https://www.npmjs.com/package/core-js)ï¼špolyfillsï¼Œä»Babel 7.4.0å¼€å§‹ï¼Œæ¨èç›´æ¥å®‰è£… **`core-js`** å³å¯ï¼Œå¤„ç†Promiseç­‰è¯­æ³•

  

- [@rollup/plugin-typescript](https://www.npmjs.com/package/@rollup/plugin-typescript)ï¼šç”¨äºå°† TypeScript æ–‡ä»¶ç¼–è¯‘ä¸º JavaScript

- [@babel/preset-typescript](https://www.npmjs.com/package/@babel/preset-typescript)ï¼šTypeScript é¢„è®¾é…ç½®

- [tslib](https://www.npmjs.com/package/tslib)ï¼šTypeScript ç¼–è¯‘åçš„ js ä»£ç çš„è¿è¡Œæ—¶åº“

  

> 1. å¸¸ç”¨æ’ä»¶åˆ—è¡¨å‚è€ƒï¼š[ç‚¹å‡»å‰å¾€ >>](https://github.com/rollup/awesome)
> 2. æ¨èé˜…è¯»ï¼š[ä¸€æ–‡å…¥é—¨rollupğŸª€ï¼13ç»„demoå¸¦ä½ è½»æ¾é©¾é©­](https://juejin.cn/post/7069555431303020580)

# å››ã€å®æˆ˜

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»¥å®æ“çš„å½¢å¼æ‰‹æŠŠæ‰‹å¸¦ç€å¤§å®¶åŸºäºrollupå°è£…å¹¶å‘å¸ƒä¸€ä¸ªjsåº“ã€‚

## 1. åˆ›å»ºç›®å½•ç»“æ„

```shell
$ mkdir -p rollup-examples/src && cd rollup-examples && touch src/index.ts && pnpm init && code . 
```

ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```
rollup-examples
.
â”œâ”€â”€ src
â”‚	â””â”€â”€	 index.ts
â””â”€â”€ package.json
```

> æç¤ºï¼š
>
> - é¡¹ç›®å **`rollup-examples`** æ ¹æ®éœ€è¦ä¿®æ”¹ã€‚
> - åŒ…ç®¡ç†å·¥å…·ä½¿ç”¨ **`pnpm`**ï¼Œè‡³äºä¸ºä»€ä¹ˆä½¿ç”¨å®ƒï¼Œæ¨èé˜…è¯» [pnpm æ˜¯å‡­ä»€ä¹ˆå¯¹ npm å’Œ yarn é™ç»´æ‰“å‡»çš„ >>](https://juejin.cn/post/7127295203177676837)

## 2. å®šä¹‰å¼€å‘è§„èŒƒ

### ä»£ç è§„èŒƒæ£€æŸ¥ä¸ä¿®å¤

ä»£ç è§„èŒƒï¼šlintå·¥å…·ï¼ˆ**eslint**ï¼‰

â‘  å®‰è£…ï¼š`pnpm i -D eslint`

â‘¡ åˆå§‹åŒ–é…ç½®æ–‡ä»¶ï¼š`pnpm create @eslint/config`

```shell
$ pnpm create @eslint/config
âœ” How would you like to use ESLint? Â· [problems]
âœ” What type of modules does your project use? Â· [esm]
âœ” Which framework does your project use? Â· [none]
âœ” Does your project use TypeScript? Â· No / [Yes]
âœ” Where does your code run? Â· [browser]
âœ” What format do you want your config file to be in? Â· [JSON]
The config that you've selected requires the following dependencies:

@typescript-eslint/eslint-plugin@latest @typescript-eslint/parser@latest
âœ” Would you like to install them now? Â· No / [Yes]
âœ” Which package manager do you want to use? Â· [pnpm]
Installing @typescript-eslint/eslint-plugin@latest, @typescript-eslint/parser@latest, eslint@latest
```

â‘¢ ä¿®æ”¹ `.eslintrc.json` é…ç½®å¦‚ä¸‹ï¼š

```json
{
  "env": {
    "browser": true,
    "es2021": true,
    "node": true
  },
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "prettier",
    "plugin:prettier/recommended"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": "latest",
    "sourceType": "module"
  },
  "plugins": ["@typescript-eslint", "prettier"],
  "rules": {
    "prettier/prettier": "error",
    "no-case-declarations": "off",
    "no-constant-condition": "off",
    "@typescript-eslint/ban-ts-comment": "off"
  }
}
```

> **æç¤º**ï¼šæ›´å¤šè§„åˆ™ï¼Œå‚è€ƒ [è¿™é‡Œ >>](https://eslint.cn/docs/rules/)

### ä»£ç é£æ ¼ prettier

â‘  å®‰è£…ï¼š`pnpm i -D prettier `

â‘¡ æ–°å»º `.prettierrc.json` é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ é…ç½®ï¼š

```json
{
 "printWidth": 80,
 "tabWidth": 2,
 "useTabs": true,
 "singleQuote": true,
 "semi": true,
 "trailingComma": "none",
 "bracketSpacing": true
}
```

â‘¢ å°† `prettier` é›†æˆåˆ° `eslint` ä¸­ï¼Œå…¶ä¸­ï¼š

- `eslint-config-prettier`ï¼šè¦†ç›– `ESLint` æœ¬èº«çš„è§„åˆ™é…ç½®
- `eslint-plugin-prettier`ï¼šç”¨ `Prettier` æ¥æ¥ç®¡ä¿®å¤ä»£ç å³ `eslint --fix`

```shell
$ pnpm i -D eslint-config-prettier eslint-plugin-prettier
```

â‘£ ä¸º `lint` å¢åŠ å¯¹åº”çš„æ‰§è¡Œè„šæœ¬ï¼š

```json
"lint": "eslint --ext .js,.ts,.jsx,.tsx --fix --quiet ./src",
```

- `--ext`ï¼šæŒ‡å®šå¤„ç†çš„æ–‡ä»¶ç±»å‹
- `--fix`ï¼šä¿®å¤é—®é¢˜
- `--quiet`ï¼šä¸è¾“å‡ºåé¦ˆ

åŒæ—¶ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥å®‰è£… `prettier` ä¸ `eslint` çš„ VSCode æ’ä»¶ï¼Œå¹¶åœ¨ `setting` ä¸­è®¾ç½®ä¸ºä¿å­˜åè‡ªåŠ¨æ‰§è¡Œã€‚

*è®¾ç½®ä¸­æœç´¢ â€œEditor:Default formatterâ€ï¼Œå°†å€¼è®¾ç½®ä¸º â€œPrettier - Code formatterâ€*ï¼Œ

*åŒæ—¶æœç´¢ â€œEditor:Format On Saveâ€ï¼Œå‹¾é€‰â€œåœ¨ä¿å­˜æ—¶æ ¼å¼åŒ–æ–‡ä»¶â€*ã€‚

### commit è§„èŒƒæ£€æŸ¥ï¼ˆhuskyï¼‰

â‘  åˆå§‹åŒ–gitä»“åº“ï¼š

```shell
$ git init 
```

â‘¡ æ ¹ç›®å½•æ–°å»º `.gitignore` å¿½ç•¥æ–‡ä»¶ï¼š

```shell
$ echo "/node_modules" > .gitignore
```

> æç¤ºï¼šæ ¹æ®éœ€è¦å¿½ç•¥å¯¹åº”çš„æ–‡ä»¶ã€‚

â‘¢ å®‰è£… [husky](https://www.npmjs.com/package/husky)ï¼Œç”¨äºæ‹¦æˆª `commit` å‘½ä»¤

```shell
$ pnpm i -D husky
```

â‘£ åˆå§‹åŒ–`husky`ï¼š

```shell
$ npx husky install
```

â‘¤ é…ç½® commit æ—¶å¯¹ä»£ç é£æ ¼å’Œè§„èŒƒè¿›è¡Œæ£€æŸ¥

åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œå°†åˆšè®¾ç½®çš„å‘½ä»¤ `npm run lint` åŠ å…¥åˆ° husky çš„ `pre-commit` é’©å­é‡Œï¼š

```shell
$ npx husky add .husky/pre-commit "npm run lint"
```

å½“æˆ‘ä»¬æ‰§è¡Œå®Œä¸Šè¿°çš„è„šæœ¬ä¹‹åï¼Œå¯ä»¥åœ¨ `.husky` ç›®å½•ä¸‹çœ‹åˆ°å¤šäº†ä¸€ä¸ª `pre-commit` çš„shellæ–‡ä»¶ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ `commit` å‘½ä»¤çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œ `npm run lint` å»è¿›è¡Œä»£ç é£æ ¼å’Œæ ¼å¼åŒ–çš„æ£€æŸ¥ã€‚

> TODOï¼š`npm run lint` ä¼šå¯¹ä»£ç å…¨é‡æ£€æŸ¥ï¼Œå½“é¡¹ç›®å¤æ‚åæ‰§è¡Œé€Ÿåº¦å¯èƒ½æ¯”è¾ƒæ…¢ï¼Œå±Šæ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨ [lint-staged](https://github.com/okonet/lint-staged)ï¼Œå®ç°åªå¯¹æš‚å­˜åŒºä»£ç è¿›è¡Œæ£€æŸ¥

â‘¥ é…ç½® commit æ—¶å¯¹æäº¤ä¿¡æ¯æ˜¯å¦è§„èŒƒè¿›è¡Œæ£€æŸ¥

é€šè¿‡ [commitlint](https://github.com/conventional-changelog/commitlint) å¯¹gitæäº¤ä¿¡æ¯è¿›è¡Œæ£€æŸ¥ï¼Œé¦–å…ˆå®‰è£…å¿…è¦çš„åº“ï¼š

```shell
$ pnpm i -D commitlint @commitlint/cli @commitlint/config-conventional
```

æ–°å»ºé…ç½®æ–‡ä»¶ `.commitlintrc.js`ï¼š

```js
module.exports = {
  extends: ["@commitlint/config-conventional"]
}; 
```

é›†æˆåˆ° `husky` ä¸­ï¼š

```shell
$ npx husky add .husky/commit-msg "npx --no-install commitlint -e $HUSKY_GIT_PARAMS"
```

ğŸ“Œ å»¶ä¼¸ï¼š**`conventional`  è§„èŒƒé›†æ„ä¹‰**

æ ¼å¼ï¼š

```
<type>: <subject> â†’ æäº¤çš„ç±»å‹: æ‘˜è¦ä¿¡æ¯
```

å¸¸ç”¨çš„ `type` å€¼åŒ…æ‹¬å¦‚ä¸‹:

- featï¼šæ·»åŠ æ–°åŠŸèƒ½
- fixï¼šä¿®å¤ Bug
- choreï¼šä¸€äº›ä¸å½±å“åŠŸèƒ½çš„æ›´æ”¹
- docsï¼šä¸“æŒ‡æ–‡æ¡£çš„ä¿®æ”¹
- perfï¼šæ€§èƒ½æ–¹é¢çš„ä¼˜åŒ–
- refactorï¼šä»£ç é‡æ„
- testï¼šæ·»åŠ ä¸€äº›æµ‹è¯•ä»£ç ç­‰ç­‰

æäº¤æ—¶çš„ä»£ç æ ¼å¼ï¼š*`git commit -m "feat: xxx"`*

> æ³¨æ„ï¼š`feat: ` åé¢è·Ÿä¸€ä¸ªç©ºæ ¼ã€‚

### é…ç½® `tsconfig.json`

```json
{
	"compileOnSave": true,
	"compilerOptions": {
		"target": "ESNext",
		"module": "ESNext",
		"lib": ["ESNext", "DOM"],
		"strict": true,
		"esModuleInterop": true,

		"declaration": true,
		"declarationDir": "dist",

		"sourceMap": true,
		"useDefineForClassFields": true,
		"moduleResolution": "Node",
		"resolveJsonModule": true,
		"isolatedModules": true,
		"noEmit": true,
		"noUnusedLocals": true,
		"noUnusedParameters": true,
		"noImplicitReturns": false,
		"skipLibCheck": true,

		"baseUrl": "./",
		"paths": {
			"@/*": ["src/*"]
		}
	}
}

```

## 3. å®‰è£…ä¾èµ–

```shell
$ pnpm i -D rollup @rollup/plugin-commonjs @rollup/plugin-node-resolve @rollup/plugin-babel @babel/core @babel/preset-env core-js @rollup/plugin-typescript @babel/preset-typescript tslib @rollup/plugin-alias @rollup/plugin-eslint @rollup/plugin-alias rollup-plugin-delete @rollup/plugin-terser rollup-plugin-generate-package-json
```

## 4. é…ç½®

### **`package.json`**

```json
{
	"name": "rollup-examples",
	"version": "1.0.0",
	"description": "",
	"type": "module",
	"types": "./dist/index.d.ts",
	"main": "./dist/index.cjs.js",
	"module": "./dist/index.esm.js",
	"exports": {
		"import": "./dist/index.esm.js",
		"require": "./dist/index.cjs.js",
		"types": "./dist/index.d.ts"
	},
	"files": [
		"dist/**/*",
		"README.md"
	],
	"scripts": {
		"lint": "eslint --ext .js,.ts,.jsx,.tsx --fix --quiet ./src",
		"build:dev": "NODE_ENV=development rollup --config ./scripts/rollup.config.js --bundleConfigAsCjs",
		"build:pro": "NODE_ENV=production rollup --config ./scripts/rollup.config.js --bundleConfigAsCjs"
	},
	"buildOptions": {
		"formats": [
			"cjs",
			"umd",
			"esm"
		],
		"name": "Examples"
	},
	"keywords": [],
	"author": "",
	"license": "ISC",
	"repository": {
		"type": "git",
		"url": "git+https://github.com/<username>/xxx.git"
	},
	"bugs": {
		"url": "https://github.com/<username>/xxx/issues"
	},
	"homepage": "https://github.com/<username>/xxx.git#readme",
	"devDependencies": { ... }
}
```

**æç¤º**ï¼šæ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ **`name`** å’Œ **`description`** å­—æ®µã€‚

å­—æ®µç®€ä»‹ï¼š

- `name`ï¼šæŒ‡å®šåº“çš„åç§°ï¼Œå¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œç”±å°å†™è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸èƒ½åŒ…å«ç©ºæ ¼ã€‚*ï¼ˆå¿…å¡«é¡¹ï¼‰*
- `version`ï¼šæŒ‡å®šåº“çš„ç‰ˆæœ¬å·ï¼Œéµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒï¼ˆSemantic Versioningï¼‰*ã€‚ï¼ˆå¿…å¡«é¡¹ï¼‰*
- `description`ï¼šå¯¹åº“çš„ç®€è¦æè¿°ã€‚
- `type`ï¼šæŒ‡å®šé¡¹ç›®çš„æ¨¡å—ç±»å‹ï¼Œå¯é€‰å€¼ï¼šcommonjsï¼Œmoduleï¼Œumdã€‚
- `types`ï¼šæŒ‡å®š TypeScript é¡¹ç›®çš„ç±»å‹å£°æ˜æ–‡ä»¶ï¼ˆ`.d.ts`ï¼‰çš„å…¥å£æ–‡ä»¶è·¯å¾„ã€‚
- `main`ï¼šå¯¹åº”CommonJSå¼•å…¥æ–¹å¼çš„ç¨‹åºå…¥å£æ–‡ä»¶ã€‚
- `module`ï¼šå¯¹åº”ESModuleå¼•å…¥æ–¹å¼çš„ç¨‹åºå…¥å£æ–‡ä»¶ã€‚
- `exports`ï¼šå®šä¹‰è‡ªå®šä¹‰å¯¼å‡ºè§„åˆ™ï¼Œ**å¯ä»¥ç†è§£ä¸ºè·¯å¾„æ˜ å°„**ã€‚
- `files`ï¼šæŒ‡å®šè¦åŒ…å«åœ¨å‘å¸ƒåŒ…ä¸­çš„æ–‡ä»¶å’Œç›®å½•ã€‚
- `scripts`ï¼šå®šä¹‰ä¸€äº›è‡ªå®šä¹‰çš„è„šæœ¬å‘½ä»¤ï¼Œå¦‚æ„å»ºã€æµ‹è¯•ã€å‘å¸ƒç­‰ã€‚
- `buildOptions`ï¼šé…ç½®æ‰“åŒ…ä¿¡æ¯ã€‚
- `keywords`ï¼šå…³é”®è¯æ•°ç»„ï¼Œç”¨äºæè¿°åº“çš„ç‰¹ç‚¹ã€ç”¨é€”ç­‰ï¼Œä¾¿äºæœç´¢å’Œå‘ç°ã€‚
- `author`ï¼šæŒ‡å®šåº“çš„ä½œè€…ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–å¯¹è±¡ã€‚
- `license`ï¼šæŒ‡å®šåº“çš„è®¸å¯è¯ç±»å‹ï¼Œç”¨äºè¯´æ˜ä»£ç çš„ä½¿ç”¨æƒé™ã€‚
- `repository`ï¼šä»“åº“ä¿¡æ¯ã€‚

### `bable.config.js`

```js
export default {
  presets: [
    [
      '@babel/preset-env',
      {
        useBuiltIns: 'usage',
        corejs: 3,
        modules: false
      }
    ],
    '@babel/preset-typescript'
  ]
};
```

> **æç¤ºï¼š** **`modules: false`** å¯ä»¥é˜»æ­¢Babelåœ¨Rollupæœ‰æœºä¼šåšå¤„ç†ä¹‹å‰ï¼Œå°†æˆ‘ä»¬çš„æ¨¡å—è½¬æˆ CommonJS ï¼Œå¯¼è‡´ Rollup çš„å¤„ç†å¤±è´¥ã€‚

### **`.browserslistrc`** (Options)

```
> 1%
last 2 version
not dead
```

> æç¤ºï¼šä½ å¯ä»¥åœ¨ [è¿™é‡Œ >>](https://caniuse.com/usage-table) æŸ¥çœ‹å½“å‰å„ä¸»æµæµè§ˆå™¨çš„å…¼å®¹æ€§æƒ…å†µï¼Œå½“æˆ‘ä»¬åœ¨æ‰“åŒ…æ ·å¼å’Œè„šæœ¬æ—¶ï¼Œå°†æ ¹æ®è¿™é‡Œçš„é…ç½®è¿›è¡Œå…¼å®¹ã€‚

### `rollup.config.js`

```js
import { defineConfig } from 'rollup';
import path from 'path';
import { nodeResolve } from '@rollup/plugin-node-resolve';
import { babel } from '@rollup/plugin-babel';
import ts from '@rollup/plugin-typescript';
import cjs from '@rollup/plugin-commonjs';
import alias from '@rollup/plugin-alias';
import del from 'rollup-plugin-delete';
import eslint from '@rollup/plugin-eslint';
import terser from '@rollup/plugin-terser';
import generatePackageJson from 'rollup-plugin-generate-package-json'
import pkg from "./package.json";


const resolve = (filePath) => path.resolve(__dirname, '.', filePath);
const isProduction = process.env.NODE_ENV === 'production';
const distPath = resolve("dist");




const commonPlugins = [
  del({ targets: 'dist/*' }),
  nodeResolve(),
  cjs(),
  ts({
    tsconfig: resolve("tsconfig.json"),
    sourceMap: !isProduction,
  }),
  alias({
    entries: [{ find: '@', replacement: './src' }]
  }),
  babel({
    extensions: ['.js', '.ts'],
    exclude: 'node_modules/**',
    babelHelpers: 'bundled'
  }),
  generatePackageJson({
    inputFolder: resolve("."),
    outputFolder: resolve("dist"),
    baseContents: (pkg) => ({
      name: pkg.name,
      description: pkg.description,
      version: pkg.version,
      types: pkg.types,
      main: pkg.main,
      module: pkg.module,
      exports: pkg.exports
    })
  })
]

const devPlugins = [
  eslint({
    include: ['src/**'],
    exclude: ['node_modules/**'],
    throwOnError: true,
    throwOnWarning: true
  })
];

const proPlugins = [
  terser({
    compress: {
      drop_console: isProduction,
      drop_debugger: isProduction
    },
    format: {
      comments: (_, comment) => {
        return /eslint\-disable/.test(comment.value); // ä¸åˆ é™¤eslintçš„æ³¨é‡Š
      }
    }
  })
]

export default defineConfig({
  input: resolve("src/index.ts"),
  output: pkg.buildOptions.formats.map(format => ({
    file: `${distPath}/index.${format}.js`,
    format,
    sourcemap: !isProduction,
    banner: '/* eslint-disable */\n',
    name: ['iife', 'umd'].includes(format) ? pkg.buildOptions.name : undefined
  })),
  plugins: [
    ...commonPlugins,
    ...(isProduction ? proPlugins : devPlugins)
  ]
});
```

## 5. æºç 

```ts
// src/index.js
export default class vTools {
	/**
	 * SUMï¼šæ±‚å’Œ
	 * @param a
	 * @param b
	 * @returns
	 */
	static sum(a: number, b: number) {
		return a + b;
	}
}
```

## 6. è°ƒè¯•

https://cn.vitest.dev/

```shell
$ mkdir examples && cd examples && pnpm create vite
```

## 7. å‘å¸ƒnpmåŒ…

å‚è€ƒï¼š

- [ã€å®˜æ–¹ã€‘Using-npm Scripts](https://docs.npmjs.com/cli/v9/using-npm/scripts?v=true)

- [ã€è¯‘ã€‘ç®€æ˜“çš„NPMè‡ªåŠ¨åŒ–å‘å¸ƒ](https://blog.csdn.net/weixin_33814685/article/details/91443437)

```
"scripts": {
  "dev": "NODE_ENV=development rollup -c -w",
  "build": "NODE_ENV=production rollup -c",
  "preversion": "npm run build",
  "postversion": "npm publish",
  "postpublish": "git push;git push --tags"
}
```

å½“æ‰§è¡Œ `npm version patch` æŒ‡ä»¤æ—¶ï¼Œè„šæœ¬è‡ªåŠ¨æ‰§è¡Œé¡ºåºï¼š`preversion` â†’ `postversion` â†’ `postpublish`

ç‰ˆæœ¬å·åŸºæœ¬æ˜¯ç”±ä¸‰ä½æ•°å­—ç»„æˆï¼š 

  1   .   0   .   0

 [MAJOR].[MINOR].[PATCH]

# äº”ã€æ‰©å±•ï¼šæ·±å…¥ç†è§£ rollup è¾“å‡ºæ ¼å¼

æ¨èé˜…è¯»ï¼š[è¯´ä¸æ¸…rollupèƒ½è¾“å‡ºå“ª6ç§æ ¼å¼ğŸ˜¥å·®ç‚¹è¢«é„™è§†]()

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå°ç¤ºä¾‹ï¼Œå¸®åŠ©å¤§å®¶ç†è§£æ¨¡å—åŒ–è§„èŒƒçš„å‡ ç§æ ¼å¼ã€‚

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼š

```shell
$ mkdir rollup-formats && cd rollup-formats && npm init -y  && mkdir src && touch src/index.js src/answer.js rollup.config.js && npm i -D rollup && npm i lodash lodash-es jquery && code .
```

ç›®å½•ç»“æ„ï¼š

```
rollup-formats
.
â”œâ”€â”€ node_modules
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ index.js
â”‚	  â””â”€â”€ anwser.js
â”œâ”€â”€ package.json
â””â”€â”€ rollup.config.js
```

å…¶ä¸­ `index.js` å’Œ `answer.js` å±äºä¸šåŠ¡ä»£ç ï¼Œæ˜¯éœ€è¦è¢«æ‰“åŒ…çš„å¯¹è±¡ã€‚åœ¨ `index.js` ä¸­ä¾èµ–äº† `answer.js`ã€‚å¦‚ä¸‹ï¼š

```js
// answer.ks
export default 30;

// index.js
import answer from './answer';
import { repeat } from 'lodash';

// -- å®šä¹‰ä¸€ä¸ªæ— ç”¨å˜é‡ï¼Œæµ‹è¯•tree-shaking
const unUsedVar = 'Hello, Rollup!';

export const printAnswer = () => {
  // 1. æ‰“å°è¾“å‡º
  console.log(`The answer is ${answer}.`);
  // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
  console.log(repeat('1', answer));
};
```

## 1. IIFE è‡ªæ‰§è¡Œå‡½æ•°

### 1.1. æ‰“åŒ…ç»“æœåˆ†æ

æ‰“åŒ…äº§ç‰©ï¼ˆ*dist/iife/bundle.js*ï¼‰ï¼š

```js
var Test = (function (exports, lodash) {
  'use strict';

  var answer = 30;

  const printAnswer = () => {
    // 1. æ‰“å°è¾“å‡º
    console.log(`The answer is ${answer}.`);
    // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
    console.log(lodash.repeat('1', answer));
  };

  exports.printAnswer = printAnswer;

  return exports;
})({}, lodash);
```

åˆ†ææ‰“åŒ…äº§ç‰©ï¼š

```js
var Test = (function (exports, lodash) {
  // â€» è‡ªå¸¦ä¸¥æ ¼æ¨¡å¼ï¼Œé¿å…ä¸€äº›å¥‡æ€ªçš„å…¼å®¹æ€§é—®é¢˜
  'use strict';

  // â€» ä¸‹é¢æŠ˜è¡Œæ— ç”¨ä»£ç è¢« tree-shaking æ‰äº†
  // â€» const unUsedVar = 'Hello, Rollup!';

  // â€» ä¸šåŠ¡ä¸­è¢«å•ä¸€å¼•ç”¨çš„æ¨¡å—ï¼Œè¢«ç›´æ¥æŠ¹å¹³äº†
  var answer = 30;

  const printAnswer = () => {
    // 1. æ‰“å°è¾“å‡º
    console.log(`The answer is ${answer}.`);
    // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
    console.log(lodash.repeat('1', answer));
  };

  // â€» æŠŠè¦exportçš„å±æ€§æŒ‚åœ¨åˆ°exportsä¸Š
  exports.printAnswer = printAnswer;

  return exports;
})({}, lodash); // â€» exportsæ˜¯ç¬¬ä¸€ä¸ªå…¥å‚ï¼Œä¾èµ–çš„jqueryæ˜¯ç¬¬äºŒä¸ªå…¥å‚
```

`IIFE` æ˜¯å‰ç«¯æ¨¡å—åŒ–æ—©æœŸçš„äº§ç‰©ï¼Œå®ƒçš„æ ¸å¿ƒæ€è·¯æ˜¯:

1. æ„å»ºä¸€ä¸ªåŒ¿åå‡½æ•°
2. ç«‹åˆ»æ‰§è¡Œè¿™ä¸ªåŒ¿åå‡½æ•°ï¼Œå¯¹å¤–éƒ¨çš„ä¾èµ–é€šè¿‡å…¥å‚çš„å½¢å¼ä¼ å…¥
3. è¿”å›è¯¥æ¨¡å—çš„è¾“å‡º

### 1.2. å¦‚ä½•è¿è¡Œ

`IIFE` çš„è¿è¡Œå…¶å®å¾ˆå®¹æ˜“ï¼Œå¦‚æœå®ƒæ²¡æœ‰å…¶ä»–ä¾èµ–ï¼Œåªéœ€è¦å»å¼•å…¥æ–‡ä»¶ï¼Œç„¶ååœ¨ `window` ä¸Šå–ç›¸åº”çš„å˜é‡å³å¯ã€‚
å¦‚ï¼š

```html
<script src="http://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script>
  // jquery å°±æ˜¯å…¸å‹çš„è‡ªæ‰§è¡Œå‡½æ•°æ¨¡å¼ï¼Œå½“ä½ å¼•å…¥åï¼Œä»–å°±ä¼šæŒ‚åœ¨åˆ° window.$ ä¸Š
  window.$
</script>
```

ä½†æ˜¯å¦‚æœä½ åƒæœ¬ç¤ºä¾‹ä¸­é‚£æ ·ä¾èµ–äº†å…¶ä»–çš„æ¨¡å—ï¼Œé‚£ä½ å°±å¿…é¡»ä¿è¯ä»¥ä¸‹ä¸¤ç‚¹æ‰èƒ½æ­£å¸¸è¿è¡Œï¼š

1. æ­¤åŒ…æ‰€ä¾èµ–çš„åŒ…ï¼Œå·²åœ¨æ­¤åŒ…ä¹‹å‰å®ŒæˆåŠ è½½ã€‚
2. å‰ç½®ä¾èµ–çš„åŒ…ï¼Œå’Œ IIFE æ‰§è¡Œå…¥å‚çš„å˜é‡å‘½åæ˜¯ä¸€è‡´çš„ã€‚

ä»¥æœ¬ç¤ºä¾‹ä¸­ IIFE æ„å»ºç»“æœä¸ºä¾‹ï¼š

1. å®ƒå‰ç½®ä¾èµ–äº† `lodash`ï¼Œå› æ­¤éœ€è¦åœ¨å®ƒåŠ è½½ä¹‹å‰å®Œæˆ `lodash` çš„åŠ è½½ã€‚
2. æ­¤ `IIFE` çš„ç¬¬äºŒä¸ªå…¥å‚æ˜¯ `lodash`ï¼Œä½œä¸ºå‰ç½®æ¡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦è®© `window.lodash` ä¹ŸæŒ‡å‘ `lodash`ã€‚ 

å› æ­¤ï¼Œè¿è¡Œæ—¶ï¼Œä»£ç å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IIFE</title>
  <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script>window.lodash = window._</script>
  <script src="../dist/iife/bundle.js"></script>
</head>

<body>

  <script>
    window.Test.printAnswer()
  </script>
</body>

</html>
```

### 1.3. ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹:
  1. é€šè¿‡é—­åŒ…è¥é€ äº†ä¸€ä¸ªâ€œç§æœ‰â€å‘½åç©ºé—´ï¼Œé˜²æ­¢å½±å“å…¨å±€ï¼Œå¹¶é˜²æ­¢è¢«ä»å¤–éƒ¨ä¿®æ”¹ç§æœ‰å˜é‡ã€‚
  2. ç®€å•æ˜“æ‡‚
  3. å¯¹ä»£ç ä½“ç§¯çš„å½±å“ä¸å¤§
- ç¼ºç‚¹ï¼š
  1. è¾“å‡ºçš„å˜é‡å¯èƒ½å½±å“å…¨å±€å˜é‡ï¼›å¼•å…¥ä¾èµ–åŒ…æ—¶ä¾èµ–å…¨å±€å˜é‡ã€‚
  2. éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œç»´æŠ¤ `script` æ ‡ç­¾çš„åŠ è½½é¡ºåºã€‚

ä¼˜ç‚¹å°±ä¸ç»†è¯´äº†ï¼Œç¼ºç‚¹è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚

**ç¼ºç‚¹ä¸€ï¼šè¾“å‡ºçš„å˜é‡å¯èƒ½å½±å“å…¨å±€å˜é‡ï¼›å¼•å…¥ä¾èµ–åŒ…æ—¶ä¾èµ–å…¨å±€å˜é‡**ã€‚

å‰åŠå¥ï¼š**è¾“å‡ºçš„å˜é‡å¯èƒ½å½±å“å…¨å±€å˜é‡;** å…¶å®å¾ˆå¥½ç†è§£ï¼Œä»¥ä¸Šé¢ç¤ºä¾‹çš„è¾“å‡ºä¸ºä¾‹ï¼š `window.Test` å°±å·²ç»è¢«å½±å“äº†ã€‚è¿™ç§æ˜æ˜¾çš„å‰¯ä½œç”¨åœ¨ç¨‹åºä¸­å…¶å®æ˜¯æœ‰éšæ‚£çš„ã€‚

ååŠå¥ï¼š**å¼•å…¥ä¾èµ–åŒ…æ—¶ä¾èµ–å…¨å±€å˜é‡ï¼›** æˆ‘ä»¬ä¸ºäº†è®©ç¤ºä¾‹æ­£å¸¸è¿è¡Œï¼Œå› æ­¤åŠ äº†ä¸€è¡Œä»£ç è®© `window.lodash` ä¹ŸæŒ‡å‘ `lodash`ï¼Œä½†å®ƒç¡®å®æ˜¯å¤ªè„†å¼±äº†ã€‚

```html
<!-- æ²¡æœ‰è¿™ä¸€è¡Œï¼Œç¤ºä¾‹å°±æ— æ³•æ­£å¸¸è¿è¡Œ -->
<script>window.lodash = window._</script>
```

ä½ ç§ï¼ŒIIFE çš„æ‰§è¡Œå¯¹ç¯å¢ƒçš„ä¾èµ–æ˜¯è‹›åˆ»çš„ï¼Œé™¤éå®ƒå®Œå…¨ä¸ä¾èµ–å¤–éƒ¨åŒ…ã€‚ï¼ˆjQuery: æ­£æ˜¯åœ¨ä¸‹ï¼ï¼‰

è™½ç„¶ IIFE çš„ç¼ºç‚¹å¾ˆå¤šï¼Œä½†å¹¶ä¸å¦¨ç¢å®ƒåœ¨ jQuery æ—¶ä»£æå¤§åœ°æ¨åŠ¨äº†Webå¼€å‘çš„è¿›ç¨‹ï¼Œå› ä¸ºå®ƒç¡®å®è§£å†³äº† js æœ¬èº«å­˜åœ¨çš„å¾ˆå¤šé—®é¢˜ã€‚

é‚£ä¹ˆï¼Ÿåç»­æ˜¯å¦è¿˜æœ‰ **æ›´ä¸ºä¼˜ç§€** çš„å‰ç«¯æ¨¡å—åŒ–æ–¹æ¡ˆé—®ä¸–å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œå¾€ä¸‹çœ‹å§ã€‚

## 2. CommonJS

### 2.1. æ‰“åŒ…ç»“æœåˆ†æ

å…ˆçœ‹çœ‹ CommonJS æ‰“åŒ…çš„ç»“æœ:

```js
'use strict';

var lodash = require('lodash');

var answer = 30;

const printAnswer = () => {
  // 1. æ‰“å°è¾“å‡º
  console.log(`The answer is ${answer}.`);
  // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
  console.log(lodash.repeat('1', answer));
};

exports.printAnswer = printAnswer;
```

ä»¥ä¸Šæ ¼å¼ï¼Œå°±æ˜¯ `CommonJS` è§„èŒƒçš„å†™æ³•

```js
// â€» CommonJS é€šè¿‡ä¸€ä¸ªå…¨å±€ require æ–¹æ³•è¿›è¡Œæ¨¡å—çš„å¼•å…¥
var lodash = require('lodash');
// â€» CommonJS è¿›è¡Œæ¨¡å—å†…æ–¹æ³•è¾“å‡ºçš„æ–¹å¼
module.exports.printAnswer = printAnswer;
// â€» ä¸Šé¢çš„å†™æ³•ä¹Ÿç­‰ä»·äº
exports.printAnswer = printAnswer;
// â€» å› ä¸º exports å˜é‡ç­‰ä»·äº module.exports
```

ä¸ºäº†è§£å†³ `node.js` åœ¨æ¨¡å—åŒ–ä¸Šçš„ç¼ºå¤±ï¼Œ **2009å¹´10æœˆ** `CommonJS` è§„èŒƒé¦–æ¬¡è¢«æå‡ºã€‚

æ³¨æ„è¿™ä¸ªå…³é”®è¯ï¼š **node.js**ï¼Œæ˜¯çš„ï¼Œ`CommonJS` å¹¶ä¸æ˜¯åœ¨æµè§ˆå™¨ç¯å¢ƒè¿è¡Œçš„è§„èŒƒï¼Œè€Œæ˜¯åœ¨ `node.js` ç¯å¢ƒä¸‹è¿è¡Œçš„ã€‚

### 2.2. å¦‚ä½•è¿è¡Œ

åˆ›å»º `run.js` è„šæœ¬ï¼Œå¦‚ä¸‹ï¼š

```js
// run.js
const Test = require('../dist/cjs/bundle');
Test.printAnswer();
```

ç„¶åï¼Œæ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼š

```shell
# æ‰§è¡Œè„šæœ¬
node ./examples/run.js
# è¾“å‡º1
> The answer is 30.
# è¾“å‡º2
> 111111111111111111111111111111
```

å¯ä»¥çœ‹å‡ºï¼Œ`node.js` ç¯å¢ƒæ˜¯å¤©ç„¶æ”¯æŒ `CommonJS` çš„ã€‚

### 2.3. ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹ï¼šå®Œå–„çš„æ¨¡å—åŒ–æ–¹æ¡ˆï¼Œå®Œç¾è§£å†³äº† `IIFE` çš„å„ç§ç¼ºç‚¹ã€‚
- ç¼ºç‚¹ï¼šä¸æ”¯æŒæµè§ˆå™¨ç¯å¢ƒï¼Œå› ä¸ºè¿™ç§åŒæ­¥çš„å¼•å…¥æ–¹å¼å¯èƒ½å¯¼è‡´æµè§ˆå™¨å‡æ­»ã€‚

å› æ­¤ï¼Œå‰ç«¯ç•Œè¿«åˆ‡åœ°éœ€è¦ä¸€ç§èƒ½åœ¨æµè§ˆå™¨ç¯å¢ƒå®Œç¾è¿è¡Œï¼Œå®Œå–„çš„æ¨¡å—åŒ–æ–¹æ¡ˆã€‚

## 3. AMD & require.js

2011å¹´ï¼Œ `amdjs-api` åœ¨ä¸šå†…è¢«æ­£å¼æå‡ºã€‚

### 3.1. æ‰“åŒ…ç»“æœåˆ†æ

amd æ ¼å¼çš„æ‰“åŒ…ç»“æœå¦‚ä¸‹ï¼š

```js
define('Test', ['exports', 'lodash'], function (exports, lodash) {
  'use strict';

  var answer = 30;

  const printAnswer = () => {
    // 1. æ‰“å°è¾“å‡º
    console.log(`The answer is ${answer}.`);
    // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
    console.log(lodash.repeat('1', answer));
  };

  exports.printAnswer = printAnswer;
});
```

å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒå†…å®¹æ˜¯ä¸€ä¸ªå…¨å±€æ–¹æ³• `define` ã€‚

`define` æ–¹æ³•æœ‰ä¸‰ä¸ªå…¥å‚ï¼Œåˆ†åˆ«æ˜¯ï¼š

- `Test`ï¼šæ¨¡å—åç§°
- `['exports', 'lodash']`ï¼šåˆ†åˆ«è¡¨ç¤ºæ¨¡å—çš„è¾“å‡ºå’Œå¤–éƒ¨ä¾èµ–
- ä¸€ä¸ªä»¥ `exports` å’Œ `lodash` ä½œä¸ºå…¥å‚çš„æ–¹æ³•ï¼Œä»£è¡¨æ¨¡å—çš„å®é™…å†…å®¹ã€‚

ç›¸æ¯”äº `IIFE` å’Œ `CommonJs` è€Œè¨€ï¼Œ`AMD` çš„å†™æ³•æ— ç–‘æ˜¯å¤æ‚ä¸”åˆ«æ‰­çš„ã€‚

ä½†å®ƒå´å®å®åœ¨åœ¨æ˜¯è§£å†³äº† `IIFE` å’Œ `CommonJS` æ‰€é¢ä¸´çš„é—®é¢˜ï¼Œå¯¹â€œæµè§ˆå™¨é‡Œå®Œå–„çš„JSæ¨¡å—æ–¹æ³•â€ æä¾›äº†ä¸€å¥—å®Œå–„çš„æ–¹æ¡ˆã€‚

å°¤å…¶æ˜¯ `amd` æ ‡å‡†çš„å®ç°æ–¹æ¡ˆï¼š`requirejs`ã€‚

`requirejs` æ‰€å®ç°çš„ `AMD` ä¸ä»…è§£å†³äº† `CommonJS` åœ¨æµè§ˆå™¨ç«¯çš„ä¸é€‚ï¼Œé€šè¿‡å¼‚æ­¥çš„æ–¹å¼è¿›è¡Œæ¨¡å—åŠ è½½å®ç°äº†ä¸ä¼šå¯¼è‡´å‡æ­»çš„èƒ½åŠ›ï¼›æ›´æ˜¯å®Œå…¨å¼¥è¡¥äº† `IIFE` å­˜åœ¨çš„å„ç±»ç¼ºé™·ã€‚

`requirejs` åœ¨ä½¿ç”¨æ—¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä»¥ä¸‹å››æ­¥æ³•ï¼š

1. åœ¨æµè§ˆå™¨å†…å¼•å…¥ `require.js`
2. é€šè¿‡ `requirejs.config` æ–¹æ³•å®šä¹‰å…¨å±€çš„ä¾èµ–
3. é€šè¿‡ `requirejs.define` æ³¨å†Œæ¨¡å—
4. é€šè¿‡ `requirejs()` å®Œæˆæ¨¡å—å¼•å…¥ã€‚

### 3.2. å¦‚ä½•è¿è¡Œ

åœ¨ [è¿™é‡Œ >>](https://requirejs.org/docs/release/2.3.6/minified/require.js) ä¸‹è½½require.js

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMD</title>
  <!-- 1. å¼•å…¥.requirejs -->
  <script src="./requirejs.js"></script>
  <!-- 2. å®šä¹‰å…¨å±€ä¾èµ– -->
  <script>
    window.requirejs.config({
      paths: {
        "lodash": "https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min"
      }
    });
  </script>
  <!-- 3. å®šä¹‰æ¨¡å— -->
  <script src="../dist/amd/bundle.js"></script>
</head>

<body>
  <!-- 4. æ¶ˆè´¹æ¨¡å— -->
  <script>
    window.requirejs(
      ["Test"], function (test) {
        test.printAnswer()
      }
    )
  </script>
</body>

</html>
```

æ‰“å¼€æµè§ˆå™¨ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºã€‚

### 3.3. ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹

1. è§£å†³äº† `CommonJS` çš„ç¼ºç‚¹
2. è§£å†³äº† `IIFE` çš„ç¼ºç‚¹
3. ä¸€å¥—å®Œå¤‡çš„æµè§ˆå™¨é‡Œ `js` æ–‡ä»¶æ¨¡å—åŒ–æ–¹æ¡ˆ

- ç¼ºç‚¹ï¼šä»£ç ç»„ç»‡å½¢å¼åˆ«æ‰­ï¼Œå¯è¯»æ€§å·®

ä½†å¥½åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†å„ç±»æ‰“åŒ…å·¥å…·ï¼Œæµè§ˆå™¨å†…çš„ä»£ç å¯è¯»æ€§å†å·®ä¹Ÿå¹¶ä¸å½±å“æˆ‘ä»¬å†™å‡ºå¯è¯»æ€§okçš„ä»£ç ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æ‹¥æœ‰äº†**é¢å‘ `node.js` çš„ `CommonJs`** å’Œ **é¢å‘æµè§ˆå™¨çš„ `AMD`** ä¸¤å¥—æ ‡å‡†ã€‚

å¦‚æœæˆ‘å¸Œæœ›æˆ‘å†™å‡ºçš„ä»£ç èƒ½åŒæ—¶è¢«**æµè§ˆå™¨**å’Œ**nodejs**è¯†åˆ«ï¼Œæˆ‘åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ

## 4. UMD ä¼Ÿå¤§çš„æ•´åˆ

å®ƒæ²¡æœ‰åšä»€ä¹ˆçªç ´æ€§çš„åˆ›é€ ï¼Œä½†å®ƒæ˜¯é›†å¤§æˆè€…ã€‚

å®ƒå¯ä»¥åœ¨ `<script>` æ ‡ç­¾ä¸­æ‰§è¡Œã€è¢« `CommonJS` æ¨¡å—åŠ è½½å™¨åŠ è½½ã€è¢« `AMD` æ¨¡å—åŠ è½½å™¨åŠ è½½ã€‚

### 4.1. æ‰“åŒ…ç»“æœåˆ†æ

UMD æ ¼å¼æ„å»ºå‡ºæ¥çš„ä»£ç çš„å¯è¯»æ€§è¿›ä¸€æ­¥é™ä½äº†ï¼Œæˆ‘ç›¸ä¿¡ä»»ä½•æ­£å¸¸äººçœ‹åˆ°ä¸‹é¢è¿™æ®µä»£ç éƒ½ä¼šæ„Ÿåˆ°ä¸€é˜µå¤´å¤§ï¼š

```js
(function (global, factory) {
  typeof exports === 'object' && typeof module !== 'undefined'
    ? factory(exports, require('lodash'))
    : typeof define === 'function' && define.amd
    ? define('Test', ['exports', 'lodash'], factory)
    : ((global =
        typeof globalThis !== 'undefined' ? globalThis : global || self),
      factory((global.Test = {}), global.lodash));
})(this, function (exports, lodash) {
  'use strict';

  var answer = 30;

  const printAnswer = () => {
    // 1. æ‰“å°è¾“å‡º
    console.log(`The answer is ${answer}.`);
    // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
    console.log(lodash.repeat('1', answer));
  };

  exports.printAnswer = printAnswer;
});
```

æ˜¯çš„ï¼Œæ•´æ•´ä¸€å¤§æ®µä»£ç ï¼Œåªæ˜¯åœ¨å¤„ç†å…¼å®¹æ€§é—®é¢˜ï¼Œåˆ¤æ–­å½“å‰åº”è¯¥ä½¿ç”¨AMDè¿˜æ˜¯CommonJSã€‚

å› æ­¤UMDçš„ä»£ç å’Œå®ç°ä¸åœ¨æ­¤è¿›è¡Œè¿‡å¤šåˆ†æï¼Œå®ƒæ‰€åšçš„æ— éä¾¿æ˜¯è®©åŒä¸€æ®µä»£ç å…¼å®¹äº†AMDå’ŒCommonJSè§„èŒƒã€‚

### 4.2. å¦‚ä½•è¿è¡Œ

- åœ¨æµè§ˆå™¨ç«¯ï¼Œå®ƒçš„è¿è¡Œæ–¹å¼å’ŒAMDå®Œå…¨ä¸€è‡´ï¼Œå¯ä»¥å®Œå…¨å‚è€ƒ `3.2` èŠ‚çš„ç¤ºä¾‹ã€‚
- åœ¨node.jsç«¯ï¼Œå®ƒåˆ™å’Œ `CommonJS` çš„è¿è¡Œæ–¹å¼å®Œå…¨ä¸€è‡´ï¼Œåœ¨æ­¤å°±ä¸èµ˜è¿°äº†ã€‚

### 4.3. ä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹ï¼šæŠ¹å¹³äº†ä¸€ä¸ªåŒ…åœ¨ `AMD` å’Œ `CommonJS` é‡Œçš„å·®å¼‚
- ç¼ºç‚¹ï¼šä¼šä¸ºäº†å…¼å®¹äº§ç”Ÿå¤§é‡ä¸å¥½ç†è§£çš„ä»£ç ã€‚ï¼ˆç†è§£éš¾åº¦ä¸åŒ…ä½“ç§¯ï¼‰

è™½ç„¶åœ¨ç¤¾åŒºçš„ä¸æ–­åŠªåŠ›ä¸‹ï¼Œ`CommonJS` ã€ `AMD` ã€ `UMD` éƒ½ç»™ä¸šç•Œäº¤å‡ºäº†è‡ªå·±çš„ç­”å·ã€‚

ä½†å¾ˆæ˜¾ç„¶ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸å¾—å·²çš„é€‰æ‹©ã€‚

æµè§ˆå™¨åº”è¯¥æœ‰è‡ªå·±çš„åŠ è½½æ ‡å‡†ã€‚

`ES6` è‰æ¡ˆé‡Œï¼Œè™½ç„¶æè¿°äº†æ¨¡å—åº”è¯¥å¦‚ä½•è¢«åŠ è½½ï¼Œä½†å®ƒæ²¡æœ‰ â€œåŠ è½½ç¨‹åºçš„è§„èŒƒâ€ã€‚

## 5. SystemJS

å› æ­¤ WHATWGï¼ˆ**W**eb **H**ypertext **A**pplication **T**echnology **W**orking **G**roupï¼Œå³ç½‘é¡µè¶…æ–‡æœ¬åº”ç”¨æŠ€æœ¯å·¥ä½œå°ç»„ï¼‰æå‡ºäº†ä¸€å¥—æ›´æœ‰è¿œè§çš„è§„èŒƒï¼š[whatwg/loader](https://github.com/whatwg/loader)ã€‚

ä¹Ÿå°±æ˜¯ **JavaScript Loader Standard** â†’ jsåŠ è½½æ ‡å‡†ï¼ˆ*æœ¬è§„èŒƒæè¿°äº†ä» JavaScript å®¿ä¸»ç¯å¢ƒä¸­åŠ è½½ JavaScript æ¨¡å—çš„è¡Œä¸ºã€‚å®ƒè¿˜æä¾›äº†ç”¨äºæ‹¦æˆªæ¨¡å—åŠ è½½è¿‡ç¨‹å’Œè‡ªå®šä¹‰åŠ è½½è¡Œä¸ºçš„ apiã€‚*ï¼‰

åŸºäºæ­¤è§„èŒƒï¼Œ`SystemJS` è¯ç”Ÿäº†ã€‚`SystemJS` æ˜¯ç›®å‰ `whatwg/loader` è§„èŒƒçš„æœ€ä½³å®è·µè€…ã€‚

```js
System.register(['lodash'], function (exports) {
  'use strict';
  var repeat;
  return {
    setters: [
      function (module) {
        repeat = module.repeat;
      },
    ],
    execute: function () {
      var answer = 30;
      const printAnswer = exports('printAnswer', () => {
        // 1. æ‰“å°è¾“å‡º
        console.log(`The answer is ${answer}.`);
        // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
        console.log(repeat('1', answer));
      });
    },
  };
});
```

å¯ä»¥çœ‹å‡ºæ¥ System çš„æ‰“åŒ…ç»“æœå…¶å®å’ŒAMDç±»ä¼¼ï¼Œæä¾›äº†å…¨å±€çš„å¯¹è±¡ Systemï¼Œå¹¶æä¾›äº†æ³¨å†Œçš„æ–¹å¼å’Œç»Ÿä¸€çš„å†™æ³•ã€‚å°±å•çº¯çš„ä»æ‰“åŒ…ç»“æœä¸Šï¼Œå…¶å®çœ‹ä¸å‡ºå®ƒç›¸æ¯”å¯¹ `AMD + require.js` æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Œ**éš¾é“åªæ˜¯å†™æ³•ä¸Šå­˜åœ¨å·®å¼‚**?

å¹¶ä¸æ­¢äºæ­¤ï¼

ç›¸æ¯”äº `require.js`ï¼Œ`SystemJS` çš„ `System.import('module/name')` æ–¹å¼å…è®¸ä½ æ›´ä¸ºâ€œæ‡’â€åœ°åŠ è½½æ¨¡å—ï¼Œè¿™æ„å‘³ç€ä½ æ— éœ€æ¯æ¬¡éƒ½åŠ è½½ä¸€å¤§å †çš„ `bundle`ï¼Œç”¨æˆ·åªéœ€è¦ä¸ºä»–èƒ½çœ‹è§çš„é¡µé¢å¼€é”€å¸¦å®½ã€‚

å¦å¤–ï¼Œæ­£å› ä¸º `SystemJS` æ˜¯é¢å‘ `whatwg/loader` è§„èŒƒå®è·µçš„ï¼Œå› æ­¤å®ƒæ˜¯é¢å‘æœªæ¥çš„æ¨¡å—ä¾èµ–æ–¹å¼ã€‚

## 6. ESM

esmè¢«è®¤ä¸ºæ˜¯ **æœªæ¥**ï¼Œä½†cjsä»ç„¶åœ¨ç¤¾åŒºå’Œç”Ÿæ€ç³»ç»Ÿä¸­å æœ‰é‡è¦åœ°ä½ã€‚esmå¯¹æ‰“åŒ…å·¥å…·æ¥è¯´æ›´å®¹æ˜“æ­£ç¡®åœ°è¿›è¡Œ treeshakingï¼Œå› æ­¤å¯¹äºåº“æ¥è¯´ï¼Œæ‹¥æœ‰è¿™ç§æ ¼å¼å¾ˆé‡è¦ã€‚æˆ–è®¸åœ¨å°†æ¥çš„æŸä¸€å¤©ï¼Œä½ çš„åº“åªéœ€è¦è¾“å‡ºesmã€‚

### 6.1. æ‰“åŒ…ç»“æœåˆ†æ

åœ¨ ESM è¢«æå‡ºæ¥ä¹‹å‰ï¼Œjs ä¸€ç›´æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„æ¨¡å—ä½“ç³»ã€‚å®ƒçš„è§„èŒƒæ˜¯é€šè¿‡ `export` å‘½ä»¤æ˜¾å¼æŒ‡å®šè¾“å‡ºçš„ä»£ç ï¼Œå†é€šè¿‡ `import` å‘½ä»¤è¾“å…¥ã€‚

```js
// å¯¼å‡ºå‘½ä»¤
export { foo };
// å¯¼å…¥æ¨¡å—
import { foo } from 'bar';
```

è¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­æœ€ä¸ºç†Ÿæ‚‰çš„å†™æ³•ï¼Œå› æ­¤ï¼ŒESM æ ¼å¼æ‰“å‡ºæ¥çš„åŒ…ï¼Œå¯è¯»æ€§ç¡®å®éå¸¸æ£’ï¼š

```js
import { repeat } from 'lodash';

var answer = 30;

const printAnswer = () => {
  // 1. æ‰“å°è¾“å‡º
  console.log(`The answer is ${answer}.`);
  // 2. æµ‹è¯• loadash çš„èƒ½åŠ›ï¼Œæ‰“å°30ä¸ª1
  console.log(repeat('1', answer));
};

export { printAnswer };
```

å’Œé˜…è¯»æˆ‘ä»¬å¹³æ—¶æ‰€å†™çš„ä¸šåŠ¡ä»£ç å®Œå…¨æ²¡æœ‰åŒºåˆ«ã€‚

> æç¤ºï¼šrollup ä¾ç„¶æ²¡æœ‰å¿˜è®°åš tree-shaking

### 6.2. å¦‚ä½•è¿è¡Œ

éƒ¨åˆ†ç°ä»£æµè§ˆå™¨å·²ç»å¼€å§‹æ”¯æŒ `<script type="module>` äº†ï¼Œå› æ­¤åœ¨æµè§ˆå™¨ä¸Šç›´æ¥ä½¿ç”¨ESMå·²æˆä¸ºç°å®ã€‚

ä½†è¿è¡Œèµ·æ¥æ‰”éœ€è¦åšä¸€äº›å‰ç½®æ­¥éª¤ï¼šæŠŠ `esm/bundle.js` æ–‡ä»¶çš„ç¬¬ä¸€è¡Œä¿®æ”¹ä¸ºï¼Œå› ä¸ºé»˜è®¤çš„lodashå¹¶ä¸æ˜¯è¾“å‡ºçš„ ESM æ ¼å¼ï¼Œå› æ­¤ä¸ºäº†æ¼”ç¤ºè¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦åšä¸€äº›ç‰¹æ®Šå¤„ç†

```js
import repeat from '../../node_modules/lodash-es/repeat.js';
```

ç¤ºä¾‹ä»£ç ï¼š

```html
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESM</title>
  <script type="module">
    import { printAnswer } from "../dist/esm/bundle.js"
    printAnswer()
  </script>
</head>

<body></body>

</html>
```

æ¥ç€æ‰§è¡Œ live-serverï¼ŒæŸ¥çœ‹æ•ˆæœ

## æ€»ç»“ï¼šåˆ†åˆ«é€‚åˆåœ¨ä»€ä¹ˆåœºæ™¯ä½¿ç”¨ï¼Ÿ

1. **IIFE** ï¼šé€‚åˆéƒ¨åˆ†åœºæ™¯ä½œä¸ºSDKè¿›è¡Œä½¿ç”¨ï¼Œå°¤å…¶æ˜¯éœ€è¦æŠŠè‡ªå·±æŒ‚åˆ° `window` ä¸Šçš„åœºæ™¯ã€‚
2. **CommonJS**ï¼š ä»…node.jsä½¿ç”¨çš„åº“ã€‚
3. **AMD**ï¼š åªéœ€è¦åœ¨æµè§ˆå™¨ç«¯ä½¿ç”¨çš„åœºæ™¯ã€‚

4. **UMD**ï¼š æ—¢å¯èƒ½åœ¨æµè§ˆå™¨ç«¯ä¹Ÿå¯èƒ½åœ¨node.jsé‡Œä½¿ç”¨çš„åœºæ™¯ã€‚

5. **SystemJs**ï¼š å’ŒUMDç±»ä¼¼ï¼Œç›®å‰è¾ƒå‡ºåçš„ `Angular` ç”¨çš„å°±æ˜¯å®ƒã€‚

6. **ESM**ï¼š
   - è¿˜ä¼šè¢«å¼•ç”¨ã€äºŒæ¬¡ç¼–è¯‘çš„åœºæ™¯ï¼ˆå¦‚ç»„ä»¶åº“ç­‰ï¼‰
   - æµè§ˆå™¨è°ƒè¯•åœºæ™¯å¦‚ `vite.js`çš„å¼€å‘æ—¶
   - å¯¹æµè§ˆå™¨å…¼å®¹



