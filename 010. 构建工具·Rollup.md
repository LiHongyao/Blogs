

# 一、概述

[Rollup >>](https://cn.rollupjs.org/) 是一个 JavaScript 模块打包工具，它专注于打包用于浏览器环境的 JavaScript 库或应用程序。Rollup 的主要目标是生成高效、精简的输出文件，它支持 ES 模块规范，能够处理各种类型的模块引入方式，例如 ES6 模块、CommonJS、AMD 等，并将它们打包为一个或多个浏览器可用的文件。

Rollup 的设计理念是将代码打包为一个或多个模块，而不是一个巨大的捆绑文件。这使得它在处理库项目时更加高效，因为它可以消除未使用的代码，并且支持 Tree Shaking（摇树优化）来删除未使用的代码片段，以减小最终输出的文件大小。

相比之下，Webpack 是一个功能更加全面的打包工具，它不仅可以处理 JavaScript 模块，还能处理其他类型的静态资源，如样式表、图片、字体等。Webpack 更加灵活和复杂，它提供了许多功能和插件，如代码分割、动态导入、热模块替换等，可以满足复杂的项目需求。Webpack 的主要优势在于支持更多的扩展性和定制化配置选项，使得它适用于更大型、复杂的项目。

因此，Rollup 更适合用于构建纯粹的 JavaScript 库，专注于生成高效的、精简的输出文件；而Webpack 更适合构建复杂的应用程序，支持处理多种类型的资源和更丰富的功能插件。选择使用哪个工具取决于项目的特点和需求。

## Webpack vs Rollup

1）Rollup优势：

1. 输出结果更加扁平
2. 自动移除未引用代码（Tree shaking，树摇）
3. 打包结果依然完全可读

2）Rollup缺陷：

1. 加载非 ESM 的第三方模块比较复杂
2. 模块最终都被打包到一个函数中，无法实现HMR
3. 浏览器环境中， 代码拆分功能依赖AMD库

3）整体而言：

1. webpack 大而全，rollup小而美

2. 如果我们正在开发应用程序，webpack

3. 开发框架或者类库：rollup

## 最佳实践

1. **构建库**：对于构建库，我们需要将输出格式设置为 `umd` 或 `es`，以便用户可以在不同的环境中使用库。
2. **构建应用程序**：对于构建应用程序，我们可以使用代码分割、按需加载等技术，提高性能。

# 二、实战

我们以打包一个NPM工具库的形式讲解 Rollup 的使用：

- 库名：`lg-js-bridge`

- 仓库：`https://github.com/LiHongyao/lg-js-bridge.git`

> **提示：**使用时，请根据自己的需求设置。

## 1. 创建项目

目录结构：

```
lg-js-bridge
.
├── src
│   └── index.ts
├── .browserslistrc
├── .eslintrc.cjs
├── .gitignore
├── babel.config.js
├── index.html
├── package.json
├── README.md
├── rollup.config.js
└── tsconfig.json
```

我们可以在终端输入如下指令快速生成上方目录结构并通过VSCode工具打开：

```shell
$ mkdir lg-js-bridge && cd lg-js-bridge && git init && git remote add origin https://github.com/LiHongyao/lg-js-bridge.git && npm init -y && mkdir src && touch src/index.ts && touch .browserslistrc && touch .gitignore && touch babel.config.js && touch index.html && touch README.md && touch rollup.config.js && touch tsconfig.json && code .
```

## 2. 安装依赖

```shell
$ npm i rollup @rollup/plugin-typescript @rollup/plugin-babel @babel/core @babel/preset-env @babel/preset-typescript tslib core-js @rollup/plugin-commonjs @rollup/plugin-node-resolve rollup-plugin-delete @rollup/plugin-terser @rollup/plugin-eslint rollup-plugin-serve @rollup/plugin-replace @typescript-eslint/eslint-plugin -D 
```

- [rollup]()：Rollup 打包工具本身。
- [@rollup/plugin-typescript](https://www.npmjs.com/package/@rollup/plugin-typescript)：用于将 TypeScript 文件编译为 JavaScript。
- [@rollup/plugin-babel](https://www.npmjs.com/package/@rollup/plugin-babel)：用于使用 Babel 进行转译。
- [@babel/core](https://www.npmjs.com/package/@babel/core)：Babel 核心库。
- [@babel/preset-env](https://www.npmjs.com/package/@babel/preset-env)：Babel 预设配置。
- [@babel/preset-typescript](https://www.npmjs.com/package/@babel/preset-typescript)：TypeScript 预设配置。
- [tslib](https://www.npmjs.com/package/tslib)：TypeScript 编译后的 JavaScript 代码的运行时库。
- [core-js](https://www.npmjs.com/package/core-js)：polyfills，从Babel 7.4.0开始，推荐直接安装 **`core-js`** 即可，处理Promise等语法
- [@rollup/plugin-commonjs](https://www.npmjs.com/package/@rollup/plugin-commonjs)：支持在 Rollup 中引用 CommonJS 规范的包，该插件的作用是将 CommonJS 模块转成 Es6 模块。
- [@rollup/plugin-node-resolve](https://www.npmjs.com/package/@rollup/plugin-node-resolve)：支持引用npm模块，解析依赖的模块路径。
- [rollup-plugin-delete](https://www.npmjs.com/package/rollup-plugin-delete)：每次打包之前清除输出目录（del）
- [@rollup/plugin-terser](https://www.npmjs.com/package/@rollup/plugin-terser)：代码压缩
- [@rollup/plugin-eslint](https://www.npmjs.com/package/@rollup/plugin-eslint)：Eslint代码检测
- [@rollup/plugin-replace](https://www.npmjs.com/package/@rollup/plugin-replace)：在 Rollup 打包过程中替换代码中的字符串或表达式（如环境变量、配置参数等）

## 3. 配置文件

### 3.1. **`.browserslistrc`**

```
> 1%
last 2 version
not dead
```

> 提示：你可以在 [这里 >>](https://caniuse.com/usage-table) 查看当前各主流浏览器的兼容性情况，当我们在打包样式和脚本时，将根据这里的配置进行兼容。

### 3.2. `.eslintrc.cjs`

在终端按下面的提示操作：

```shell
$ npm init @eslint/config
✔ How would you like to use ESLint? · problems
✔ What type of modules does your project use? · esm
✔ Which framework does your project use? · none
✔ Does your project use TypeScript? · No / [Yes]
✔ Where does your code run? · browser
✔ What format do you want your config file to be in? · JavaScript
✔ Would you like to install them now? · No / [Yes]
✔ Which package manager do you want to use? · npm
```

配置 **`rules`**：

```js
{
  'no-console': 0, // 禁止使用console
  'no-debugger': 2, // 禁止使用debugger
  'no-explicit-any': 0,
  '@typescript-eslint/no-explicit-any': 'off',
}
```

> **提示**：更多规则，参考 [这里 >>](https://eslint.cn/docs/rules/)

### 3.3. `.gitignore`

```
node_modules
/lib
```

### 3.4. `bable.config.js`

```js
export default {
  presets: [
    [
      '@babel/preset-env',
      {
        useBuiltIns: 'usage',
        corejs: 3,
        modules: false,
      },
    ],
    '@babel/preset-typescript',
  ],
};
```

> **提示：** **`modules: false`** 可以阻止Babel在Rollup有机会做处理之前，将我们的模块转成 CommonJS ，导致 Rollup 的处理失败。

### 3.5. `index.html`

```html
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>lg-js-bridge</title>
</head>

<body>
  <script src="./lib/index.js"></script>
  <script>
    const jsBridge = window['jsBridge'];
    console.log(jsBridge);
    const sum = jsBridge.sum(10, 20);
    console.log(sum);
  </script>
</body>

</html>
```

### 3.6. **`package.json`**

字段简介：

- `name`：指定库的名称，必须是唯一的，由小写英文字母、数字和下划线组成，不能包含空格。*（必填项）*
- `version`：指定库的版本号，遵循语义化版本规范（Semantic Versioning）*。（必填项）*
- `description`：对库的简要描述。
- `private`：是否私有，如果为私有将无法发布。
- `main`：指定库的主入口文件，一般是编译后的代码，若没有指定，默认找 index.js 文件。
- `types`：指定 TypeScript 项目的类型声明文件（`.d.ts`）的入口文件路径。
- `type`：指定项目的模块类型，可选值：commonjs,module,umd。
- `files`：指定要包含在发布包中的文件和目录。
- `scripts`：定义一些自定义的脚本命令，如构建、测试、发布等。
- `keywords`：关键词数组，用于描述库的特点、用途等，便于搜索和发现。
- `author`：指定库的作者信息，可以是字符串或对象。
- `license`：指定库的许可证类型，用于说明代码的使用权限。
- `repository`：仓库信息。

配置示例：

```json
{
  "name": "lg-js-bridge",
  "version": "1.0.0",
  "description": "移动应用（iOS/Android）与H5交互方法",
  "main": "lib/index.js",
  "types": "lib/index.d.ts",
  "type": "module",
  "files": [
    "lib/**/*"
  ],
  "scripts": {
    "dev": "NODE_ENV=development rollup -c -w",
    "build": "NODE_ENV=production rollup -c",
    "preversion": "npm run build",
    "postversion": "npm publish",
    "postpublish": "git push;git push --tags"
  },
  "repository": {
    "type": "git",
    "url": "git+https://github.com/LiHongyao/lg-js-bridge.git"
  },
  "keywords": [],
  "author": "Li-HONGYAO",
  "license": "ISC",
  "bugs": {
    "url": "https://github.com/LiHongyao/lg-js-bridge/issues"
  },
  "homepage": "https://github.com/LiHongyao/lg-js-bridge#readme",
}
```

> **提示**：根据自己的需求修改 **`name`** 和 **`description`** 字段。

### 3.7. `rollup.config.js`

```js
// -- imports
import { defineConfig } from 'rollup';
import { babel } from '@rollup/plugin-babel';
import { nodeResolve } from '@rollup/plugin-node-resolve';
import commonjs from '@rollup/plugin-commonjs';
import typescript from '@rollup/plugin-typescript';
import del from 'rollup-plugin-delete';
import terser from '@rollup/plugin-terser';
import eslint from '@rollup/plugin-eslint';
import serve from 'rollup-plugin-serve';
import replace from '@rollup/plugin-replace';
import { networkInterfaces } from 'os';

// -- 获取本机的 IP 地址
function getIPAddress() {
  const interfaces = networkInterfaces();
  for (const name of Object.keys(interfaces)) {
    for (const iface of interfaces[name]) {
      const { address, family, internal } = iface;
      if (family === 'IPv4' && !internal) {
        return address;
      }
    }
  }
  return 'localhost';
}

// -- 分环境配置插件
const isProd = process.env.NODE_ENV === 'production';
let envPlugins = [];
if (isProd) {
  envPlugins = [
    terser({
      compress: {
        drop_console: true,
      },
    }),
    eslint({
      include: ['src/**'],
      exclude: ['node_modules/**'],
      throwOnError: true, // 出现ESLint错误时，打断打包进程
      throwOnWarning: true, // 出现ESLint警告时，打断打包进程
    }),
  ];
} else {
  envPlugins = [
    serve({
      port: 8888,
      contentBase: '', // 空字符串表示当前目录
      openPage: '/index.html',
      host: getIPAddress(),
    }),
  ];
}

// -- 配置文件
export default defineConfig({
  input: 'src/index.ts',
  output: {
    file: 'lib/index.js',
    format: 'umd',
    name: 'JSBridge',
    sourcemap: process.env.NODE_ENV === 'development',
  },
  plugins: [
    del({ targets: 'lib/*' }),
    replace({
      'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV),
      preventAssignment: true,
    }),
    nodeResolve(),
    commonjs(),
    typescript(),
    babel({
      extensions: ['.js', '.ts'],
      exclude: 'node_modules/**',
      babelHelpers: 'bundled',
    }),
    ...envPlugins,
  ],
});
```

> **提示：**根据自己的需求修改 **`output.name`**，该字段决定了你在  **`window`** 对象上引用的名称。

### 3.8. `tsconfig.json`

```json
{
  "compilerOptions": {
    "declaration": true,
    "declarationDir": "lib"
  }
}
```

## 4. 源码示例

```ts
class JSBridge {
  /**
   * 求两个数之和
   * @param a
   * @param b
   * @returns
   */
  public static sum(a: number, b: number) {
    console.log('123');
    return a + b;
  }
}

export default JSBridge;
```

## 5. 执行脚本测试

```shell
$ npm run dev
$ npm run build
```

## 6. 发布NPM包

参考：

- [【官方】Using-npm Scripts](https://docs.npmjs.com/cli/v9/using-npm/scripts?v=true)

- [【译】简易的NPM自动化发布](https://blog.csdn.net/weixin_33814685/article/details/91443437)

```
"scripts": {
  "dev": "NODE_ENV=development rollup -c -w",
  "build": "NODE_ENV=production rollup -c",
  "preversion": "npm run build",
  "postversion": "npm publish",
  "postpublish": "git push;git push --tags"
}
```

当执行 `npm version patch` 指令时，脚本自动执行顺序：`preversion` → `postversion` → `postpublish`

版本号基本是由三位数字组成： 

  1   .   0   .   0

 [MAJOR].[MINOR].[PATCH]

# 三、拓展

常用插件列表：[点击前往 >>](https://github.com/rollup/awesome)



