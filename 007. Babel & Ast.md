# ä¸€ã€æ¦‚è¿°

## 1. èµ·æº

[Babel >>](<https://www.babeljs.cn/>) æœ€å¼€å§‹å« **6to5**ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ **es6** è½¬ **es5**ï¼Œä½†æ˜¯åæ¥éšç€ ECMAScript æ ‡å‡†çš„æ¼”è¿›ï¼Œæœ‰äº† es7ã€es8 ç­‰ç­‰ï¼Œ **6to5** çš„åå­—å·²ç»ä¸åˆé€‚äº†ï¼Œå›¢é˜Ÿå†³å®šå°†å®ƒé‡å‘½åä¸º **babel**ã€‚

babel æ˜¯ [å·´åˆ«å¡”](https://baike.baidu.com/item/%E5%B7%B4%E5%88%AB%E5%A1%94/67557) çš„æ„æ€ï¼Œæ¥è‡ªåœ£ç»ä¸­çš„å…¸æ•…ï¼š

> å½“æ—¶äººç±»è”åˆèµ·æ¥å…´å»ºå¸Œæœ›èƒ½é€šå¾€å¤©å ‚çš„é«˜å¡”ï¼›ä¸ºäº†é˜»æ­¢äººç±»çš„è®¡åˆ’ï¼Œä¸Šå¸è®©äººç±»è¯´ä¸åŒçš„è¯­è¨€ï¼Œä½¿äººç±»ç›¸äº’ä¹‹é—´ä¸èƒ½æ²Ÿé€šï¼Œè®¡åˆ’å› æ­¤å¤±è´¥ï¼Œäººç±»è‡ªæ­¤å„æ•£ä¸œè¥¿ï¼Œâ€œ**å·´åˆ«å¡”**â€ å³ç”±æ­¤å¾—åã€‚

## 2. ç”¨é€”

- **â‘  è¯­æ³•è½¬æ¢**

  æŠŠä»£ç ä¸­çš„ ESNext ã€TypeScript æˆ–è€… Flow çš„è¯­æ³•ç­‰ç­‰ï¼Œè½¬æˆåŸºäºç›®æ ‡ç¯å¢ƒæ”¯æŒçš„è¯­æ³•çš„å®ç°ã€‚å¹¶ä¸”è¿˜å¯ä»¥æŠŠç›®æ ‡ç¯å¢ƒä¸æ”¯æŒçš„ API è¿›è¡Œ polyfillã€‚

- **â‘¡ ç‰¹å®šç”¨é€”çš„ä»£ç è½¬æ¢**

  é€šè¿‡ Babel æä¾›çš„ API å¯ä»¥å®Œæˆä»£ç åˆ° AST çš„è§£æã€è½¬æ¢ï¼Œä»¥åŠç›®æ ‡ä»£ç çš„ç”Ÿæˆã€‚ å¼€å‘è€…å¯ä»¥ç”¨å®ƒæ¥å®Œæˆä¸€äº›ç‰¹å®šç”¨é€”çš„è½¬æ¢ï¼Œæ¯”å¦‚å‡½æ•°æ’æ¡©ï¼ˆå‡½æ•°ä¸­è‡ªåŠ¨æ’å…¥ä¸€äº›ä»£ç ï¼Œä¾‹å¦‚åŸ‹ç‚¹ä»£ç ï¼‰ã€è‡ªåŠ¨å›½é™…åŒ–ç­‰ã€‚

- **â‘¢ ä»£ç çš„é™æ€åˆ†æ**
  
  é™æ€åˆ†ææ˜¯åœ¨ä¸éœ€è¦æ‰§è¡Œä»£ç çš„å‰æä¸‹å¯¹ä»£ç è¿›è¡Œåˆ†æçš„å¤„ç†è¿‡ç¨‹ ï¼ˆæ‰§è¡Œä»£ç çš„åŒæ—¶è¿›è¡Œä»£ç åˆ†æå³æ˜¯åŠ¨æ€åˆ†æï¼‰ã€‚ é™æ€åˆ†æçš„ç›®çš„æ˜¯å¤šç§å¤šæ ·çš„ï¼Œ å®ƒå¯ç”¨äºè¯­æ³•æ£€æŸ¥ï¼Œç¼–è¯‘ï¼Œä»£ç é«˜äº®ï¼Œä»£ç è½¬æ¢ï¼Œä¼˜åŒ–ï¼Œå‹ç¼©ç­‰ç­‰åœºæ™¯ã€‚æ¯”å¦‚ï¼š
  
  - linter å·¥å…·å°±æ˜¯åˆ†æ AST çš„ç»“æ„ï¼Œå¯¹ä»£ç è§„èŒƒè¿›è¡Œæ£€æŸ¥ã€‚
  - Api æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆå·¥å…·ï¼Œå¯ä»¥æå–æºç ä¸­çš„æ³¨é‡Šï¼Œç„¶åç”Ÿæˆæ–‡æ¡£ã€‚
  - Type checker ä¼šæ ¹æ®ä» AST ä¸­æå–çš„æˆ–è€…æ¨å¯¼çš„ç±»å‹ä¿¡æ¯ï¼Œå¯¹ AST è¿›è¡Œç±»å‹æ˜¯å¦ä¸€è‡´çš„æ£€æŸ¥ï¼Œä»è€Œå‡å°‘è¿è¡Œæ—¶å› ç±»å‹å¯¼è‡´çš„é”™è¯¯ã€‚
  - å‹ç¼©æ··æ·†å·¥å…·ï¼Œè¿™ä¸ªä¹Ÿæ˜¯åˆ†æä»£ç ç»“æ„ï¼Œè¿›è¡Œåˆ é™¤æ­»ä»£ç ã€å˜é‡åæ··æ·†ã€å¸¸é‡æŠ˜å ç­‰å„ç§ç¼–è¯‘ä¼˜åŒ–ï¼Œç”Ÿæˆä½“ç§¯æ›´å°ã€æ€§èƒ½æ›´ä¼˜çš„ä»£ç 
  - JavaScript è§£é‡Šå™¨ï¼Œé™¤äº†å¯¹ AST è¿›è¡Œå„ç§ä¿¡æ¯çš„æå–å’Œæ£€æŸ¥ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥è§£é‡Šæ‰§è¡Œ ASTã€‚

## 3. è½¬æ¢å·¥å…·

- **ç¼–è¯‘å™¨**ï¼ˆ`Compiler`ï¼‰ï¼šé«˜çº§è¯­è¨€ â†’ ä½çº§è¯­è¨€ã€‚
- **è½¬è¯‘å™¨**ï¼ˆ`Transpiler`ï¼‰ï¼šé«˜çº§è¯­è¨€ â†’ é«˜çº§è¯­è¨€ã€‚

é«˜çº§è¯­è¨€ï¼šæœ‰å¾ˆå¤šç”¨äºæè¿°é€»è¾‘çš„è¯­è¨€ç‰¹æ€§ï¼Œæ¯”å¦‚åˆ†æ”¯ã€å¾ªç¯ã€å‡½æ•°ã€é¢å‘å¯¹è±¡ç­‰ï¼Œæ¥è¿‘äººçš„æ€ç»´ï¼Œå¯ä»¥è®©å¼€å‘è€…å¿«é€Ÿçš„é€šè¿‡å®ƒæ¥ è¡¨è¾¾å„ç§é€»è¾‘ã€‚æ¯”å¦‚ Objective-Cã€JavaScript ç­‰ã€‚

ä½çº§è¯­è¨€ï¼šä¸ç¡¬ä»¶å’Œæ‰§è¡Œç»†èŠ‚æœ‰å…³ï¼Œä¼šæ“ä½œå¯„å­˜å™¨ã€å†…å­˜ï¼Œå…·ä½“åšå†…å­˜ä¸å¯„å­˜å™¨ä¹‹é—´çš„å¤åˆ¶ï¼Œéœ€è¦å¼€å‘è€…ç†è§£ç†Ÿæ‚‰è®¡ç®—æœºçš„å·¥ä½œåŸç†ï¼Œç†Ÿæ‚‰å…·ä½“çš„æ‰§è¡Œç»†èŠ‚ã€‚æ¯”å¦‚æ±‡ç¼–è¯­è¨€ã€æœºå™¨è¯­è¨€ã€‚

> ç»“è®ºï¼š`Babel`  å°±æ˜¯ä¸€ä¸ª  **`JavaScript Transpiler`**ã€‚

å°½ç®¡ [å®˜ç½‘ >>](https://www.babeljs.cn/) æ ‡é¢˜ä»‹ç»Babel æ˜¯ä¸€ä¸ª JavaScript ç¼–è¯‘å™¨ï¼Œä½†ä¾§é‡ç‚¹åœ¨äº **ä¸‹ä¸€ä»£**ã€‚

## 4. ç¼–è¯‘æµç¨‹

Babel çš„ç¼–è¯‘æµç¨‹ï¼šé¦–å…ˆæŠŠ **æºç ** è§£æï¼ˆ`parse`ï¼‰æˆ `AST`ï¼ˆ*æŠ½è±¡è¯­æ³•æ ‘*ï¼‰ï¼Œç„¶åé€’å½’éå† `AST` å¹¶å¯¹é½è¿›è¡Œå¢åˆ æ”¹ç”Ÿæˆæ–°çš„ ASTï¼Œæœ€åå°†æ–°çš„ AST ç”Ÿæˆ ç›®æ ‡ä»£ç  / SourceMapã€‚

ç®€å•ç†è§£ï¼Œå°±æ˜¯ï¼š`Parse` â†’ `Transform` â†’ `Generate`

# äºŒã€AST - æŠ½è±¡è¯­æ³•æ ‘

## 1. What's ASTï¼Ÿ

![](./IMGS/javascript_ast.png)

**æŠ½è±¡è¯­æ³•æ ‘**ï¼ˆ**A**bstract **S**yntax **T**reeï¼ŒASTï¼‰ï¼Œæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒä»¥ **æ ‘çŠ¶** çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚ä¹‹æ‰€ä»¥è¯´è¯­æ³•æ˜¯â€œæŠ½è±¡â€çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„è¯­æ³•å¹¶ä¸ä¼šè¡¨ç¤ºå‡ºçœŸå®è¯­æ³•ä¸­å‡ºç°çš„æ¯ä¸ªç»†èŠ‚ã€‚æ¯”å¦‚ï¼Œä¼šçœç•¥æ‰ä¸€äº›æ— å…·ä½“æ„ä¹‰çš„åˆ†éš”ç¬¦å¦‚ `;`ã€`{}`  ç­‰ç­‰ã€‚

ç®€å•ç†è§£ï¼Œå°±æ˜¯æŠŠæˆ‘ä»¬å†™çš„ä»£ç æŒ‰ç…§ä¸€å®šçš„è§„åˆ™è½¬æ¢æˆä¸€ç§ **æ ‘å½¢ç»“æ„**ã€‚

## 2. ç”¨é€”

ASTåœ¨å‰ç«¯æ— å¤„ä¸åœ¨ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„å¼€å‘å·¥å…·å‡ ä¹å…¨ä¾èµ–äºASTè¿›è¡Œå¼€å‘ï¼šæ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„babelæ’ä»¶å°† es6 â†’ es5 ã€ts â†’ js ã€ä»£ç å‹ç¼©ã€CSSé¢„å¤„ç†å™¨ã€eslintç­‰ç­‰ï¼Œä»–ä»¬åœ¨æˆ‘ä»¬çš„å®é™…å¼€å‘ä¸­éƒ½æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œè€Œä»–ä»¬çš„åº•å±‚åŸç†å…¶å®ä¹Ÿéƒ½æ˜¯ASTã€‚ã€‚å¦‚æœä½ æƒ³äº†è§£ JavaScript ç¼–è¯‘æ‰§è¡Œï¼ˆæ¯”å¦‚V8å¼•æ“çš„ç¼–è¯‘æ‰§è¡Œè¿‡ç¨‹ï¼‰çš„åŸç†å¹¶æŒæ¡å…¶ç²¾é«“ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»å¾—äº†è§£ ASTã€‚

## 3. AST å¦‚ä½•ç”Ÿæˆï¼Ÿ

ä»£ç æ‰§è¡Œçš„ç¬¬ä¸€æ­¥æ˜¯è¯»å–ä»£ç æ–‡ä»¶ä¸­çš„ **å­—ç¬¦æµ**ï¼Œç„¶åé€šè¿‡ **è¯æ³•åˆ†æ** ç”Ÿæˆ `token`ï¼Œä¹‹åå†é€šè¿‡ **è¯­æ³•åˆ†æ** ç”Ÿæˆ ASTï¼Œæœ€å **ç”Ÿæˆ** æœºå™¨ç æ‰§è¡Œã€‚æ•´ä¸ªè§£æè¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š

- **è¯æ³•åˆ†æ**ï¼šå°†æ•´ä¸ªä»£ç å­—ç¬¦ä¸²åˆ†å‰²æˆæœ€å°è¯­æ³•å•å…ƒæ•°ç»„ï¼›
- **è¯­æ³•åˆ†æ**ï¼šåœ¨åˆ†è¯åŸºç¡€ä¸Šå»ºç«‹åˆ†æè¯­æ³•å•å…ƒä¹‹é—´çš„å…³ç³»ï¼›

### 3.1. è¯æ³•åˆ†æã€Œåˆ†è¯ã€

è¯æ³•åˆ†æï¼Œä¹Ÿç§°ä¹‹ä¸º **æ‰«æ**ï¼ˆ`Scanner`ï¼‰ æˆ–è€… **ä»¤ç‰ŒåŒ–**ï¼ˆ`Token`ï¼‰ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯å°†å­—ç¬¦æµï¼ˆ`Char-Stream`ï¼‰è½¬æ¢ä¸ºä»¤ç‰Œæµï¼ˆ`Token-Stream`ï¼‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨æºä»£ç çš„åŸºç¡€ä¸Šè¿›è¡Œåˆ†è¯ã€‚

æ¯”å¦‚æŠŠ **â€œæˆ‘çˆ±ä¸­å›½â€**  è¿™æ®µå­—ç¬¦ä¸²æ ¹æ®æŸç§è§„åˆ™æ‹†è§£æˆ **â€œæˆ‘â€**ã€**â€œçˆ±â€**ã€**â€œä¸­å›½â€** ä¸‰éƒ¨åˆ†ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«åš **åˆ†è¯**ï¼Œå…¶ä¸­å„ä¸ªéƒ¨åˆ†åˆè¢«ç§°ä¸º **è¯æ³•å•å…ƒ** æˆ–è€…å« `Token`ï¼Œå¯¹äºä»£ç æ¥è¯´ï¼Œéœ€è¦å°†ä»£ç ç‰‡æ®µè¯†åˆ«ä¸ºå…³é”®å­—ã€æ ‡è¯†ç¬¦ã€æ“ä½œç¬¦ã€å­—é¢é‡ç­‰éƒ¨åˆ†ã€‚

æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œè¯æ³•åˆ†æå°±æ˜¯æŠŠä½ çš„ä»£ç ä» `string` ç±»å‹è½¬æ¢æˆäº†æ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ å°±æ˜¯ä»£ç é‡Œçš„å•è¯ï¼ˆè¯æ³•å•å…ƒï¼‰ï¼Œå¹¶ä¸”æ ‡è®°äº†æ¯ä¸ªå•è¯çš„ç±»å‹ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š

```javascript
const a = 10;
```

è¯æ³•åˆ†æå™¨ **ä»å·¦å¾€å³é€ä¸ªå­—ç¬¦æ‰«æåˆ†æ** æ•´ä¸ªç¨‹åºçš„å­—ç¬¦ä¸²ï¼Œå½“é‡åˆ°ä¸åŒçš„å­—ç¬¦æ—¶ï¼Œä¼šé©±ä½¿å®ƒè¿ç§»åˆ°ä¸åŒçš„çŠ¶æ€ã€‚åœ¨æ‰«æå­—ç¬¦çš„æ—¶å€™ï¼Œé‡åˆ° `c` å­—æ¯ï¼Œå¦‚æœåé¢è¿˜æœ‰å­—ç¬¦ï¼Œå°†ç»§ç»­æ‰«æï¼Œç›´åˆ°é‡åˆ°ç©ºæ ¼ï¼Œè¯†åˆ«å‡º `const`ï¼Œå‘ç°æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œå°†å…¶ç”Ÿæˆè¯æ³•å•å…ƒ ` { type: 'Keyword', value: 'const' }`ï¼Œç„¶åæ¥ç€æ‰«æï¼Œä»¥æ­¤ç±»æ¨ï¼Œç”Ÿæˆ `Token List`ã€‚

æ‰€ä»¥ï¼Œè¿™æ®µç¨‹åºä¼šè¢«åˆ†è§£æˆä¸ºä¸‹é¢è¿™äº›è¯æ³•å•å…ƒï¼š`let` ã€`a`ã€`=`ã€`10`ã€ `;`ï¼Œä½ å¯ä»¥åœ¨ [è¿™é‡Œ >>](https://esprima.org/demo/parse.html?code=const%20a%20%3D%2010%3B%0A) æŸ¥çœ‹è¯æ³•åˆ†æç»“æœï¼š

```javascript
[
  { type: 'Keyword',    value: 'const' },
  { type: 'Identifier', value: 'a'     },
  { type: 'Punctuator', value: '='     },
  { type: 'Numeric',    value: '10'    },
  { type: 'Punctuator', value: ';'     },
];
```

é€šè¿‡ä¸Šé¢åˆ†è§£å‡ºæ¥çš„è¯æ³•åˆ†æç»“æœï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œç¼ºå°‘ä¸€äº›æ¯”è¾ƒå…³é”®çš„ä¿¡æ¯ï¼š

- æ²¡æœ‰ä»»ä½•è¯­æ³•ä¿¡æ¯ï¼›

- ä½“ç°ä¸äº†ä»£ç çš„æ‰§è¡Œé¡ºåºï¼›

æ‰€ä»¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è¿›è¡Œ **è¯­æ³•åˆ†æ**ã€‚

### 3.2. è¯­æ³•åˆ†æã€Œè§£æã€

è¯­æ³•åˆ†æä¼šå°†è¯æ³•åˆ†æå‡ºæ¥çš„ **è¯æ³•å•å…ƒ** è½¬åŒ–æˆæœ‰è¯­æ³•å«ä¹‰çš„ **æŠ½è±¡è¯­æ³•æ ‘ç»“æ„ï¼ˆASTï¼‰**ã€‚åŒæ—¶ï¼ŒéªŒè¯è¯­æ³•ï¼Œè¯­æ³•å¦‚æœæœ‰é”™çš„è¯ï¼Œå°†æŠ›å‡ºè¯­æ³•é”™è¯¯ã€‚

è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æä¸æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œè€Œæ˜¯äº¤é”™è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯æ³•åˆ†æå™¨ä¸ä¼šåœ¨è¯»å–æ‰€æœ‰çš„è¯æ³•è®°å·åå†ä½¿ç”¨è¯­æ³•åˆ†æå™¨æ¥å¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¯å–å¾—ä¸€ä¸ªè¯æ³•è®°å·ï¼Œå°±å°†å…¶é€å…¥è¯­æ³•åˆ†æå™¨è¿›è¡Œåˆ†æã€‚

![](./IMGS/js-token-ast.png)

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨çº¿å·¥å…·ç”Ÿæˆ ASTï¼š[AST explorer >>](https://astexplorer.net/) æˆ–è€… [Esprima.org >>](https://esprima.org/demo/parse.html)ï¼Œè¿™é‡Œä¸»è¦ç®€å•ä»‹ç»ä¸‹ `AST explorer` çš„ä½¿ç”¨ï¼š

![](./IMGS/ast_explorer.png)

æ¯”å¦‚è¿™ä¸€æ®µä»£ç ï¼š

```javascript
function square(n) {
  return n * n;
}
```

ç»è¿‡è½¬åŒ–ï¼Œè¾“å‡º **AST** ç»“æ„å¦‚ä¸‹ï¼š

![](./IMGS/ast_eg1.png)

ä½ ä¼šç•™æ„åˆ° AST çš„æ¯ä¸€å±‚éƒ½æ‹¥æœ‰ç›¸åŒçš„ç»“æ„ï¼š

```javascript
{
    type: "FunctionDeclaration",
    id: {...},
    params: [...],
    body: {...}
}
```

```javascript
{
    type: "Identifier",
    name: ...
}
```

```javascript
{
    type: "BinaryExpression",
    operator: ...,
    left: {...},
    right: {...}
}
```

> æç¤ºï¼šå‡ºäºç®€åŒ–çš„ç›®çš„ç§»é™¤äº†æŸäº›å±æ€§ã€‚

è¿™æ ·çš„æ¯ä¸€å±‚ç»“æ„ï¼Œè¢«ç§°ä¸º **èŠ‚ç‚¹**ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½åŒ…å« `type` å±æ€§ï¼Œç”¨äºè¡¨ç¤ºèŠ‚ç‚¹ç±»å‹ï¼Œæ¯”å¦‚ï¼š*`FunctionDeclaration`*ã€*`Identifier`*ã€*`BinaryExpression`* ç­‰ç­‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒBabel è¿˜ä¸ºæ¯ä¸ªèŠ‚ç‚¹é¢å¤–ç”Ÿæˆäº†ä¸€äº›å±æ€§ï¼Œç”¨äºæè¿°è¯¥èŠ‚ç‚¹åœ¨åŸå§‹ä»£ç ä¸­çš„ä½ç½®ï¼Œæ¯”å¦‚ï¼š *`start`*ã€*`end`*ã€*`loc`*ã€‚

## 4. èŠ‚ç‚¹ç±»å‹

äº†è§£äº†ASTç»“æ„çš„åŸºæœ¬å½¢çŠ¶ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»ASTèŠ‚ç‚¹ç±»å‹ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªå¤§ç±»ï¼š**å­—é¢é‡**ã€**æ ‡å¿—ç¬¦**ã€**è¯­å¥**ã€**å£°æ˜**ã€**è¡¨è¾¾å¼**ã€**æ³¨é‡Š** ç­‰ç­‰ã€‚

è¿™é‡Œä¸»è¦åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„ç±»å‹ï¼Œæ›´å¤šèŠ‚ç‚¹ç±»å‹è¯·å‚è€ƒ [@babel/types >>](https://www.babeljs.cn/docs/babel-types#aliases)

### 4.1. å­—é¢é‡ã€Œ[Literal >>](https://www.babeljs.cn/docs/babel-types#literal)ã€

| ç±»å‹åç§°         | ä¸­æ–‡è¯‘å     | æè¿°                                      |
| ---------------- | ------------ | ----------------------------------------- |
| `StringLiteral`  | å­—ç¬¦å‹å­—é¢é‡ | é€šå¸¸æŒ‡å­—ç¬¦ä¸²ç±»å‹çš„å­—é¢é‡ï¼š`'Hello, AST!'` |
| `NumericLiteral` | æ•°å€¼å‹å­—é¢é‡ | é€šå¸¸æŒ‡æ•°å­—ç±»å‹çš„å­—é¢é‡ï¼š`123`             |
| `BooleanLiteral` | å¸ƒå°”å‹å­—é¢é‡ | é€šå¸¸æŒ‡å¸ƒå°”ç±»å‹å€¼ï¼š`true` / `false`        |
| `RegExpLiteral`  | æ­£åˆ™å‹å­—é¢é‡ | é€šå¸¸æŒ‡æ­£åˆ™è¡¨è¾¾å¼ï¼š`/[0-9]/`               |
| `TemplatLiteral` | æ¨¡æ¿å‹å­—é¢é‡ | é€šå¸¸æŒ‡æ¨¡æ¿å­—ç¬¦ä¸²ï¼ˆ`ï¼‰                     |

*æç¤ºï¼šè¿™é‡Œä¸»è¦å±•ç¤ºå¸¸ç”¨çš„å­—é¢é‡ç±»å‹ï¼Œæ›´å¤šè¯¦æƒ…è¯·å‚è€ƒ[è¿™é‡Œ >>](https://www.babeljs.cn/docs/babel-types#literal)*

### 4.2. æ ‡å¿—ç¬¦ã€ŒIdentifierã€

ç¨‹åºä¸­æ‰€æœ‰çš„ å˜é‡åã€å‡½æ•°åã€å¯¹è±¡é”®ï¼ˆ`key`ï¼‰ ä»¥åŠå‡½æ•°ä¸­çš„å‚æ•°åï¼Œéƒ½å±äºæ ‡å¿—ç¬¦ã€‚

### 4.3. è¯­å¥ã€Œ[Statement >>](https://www.babeljs.cn/docs/babel-types#statement)ã€

è¯­å¥æ˜¯èƒ½å¤Ÿç‹¬ç«‹æ‰§è¡Œçš„åŸºæœ¬å•ä½ï¼Œå¸¸è§çš„è¯­å¥ç±»å‹æœ‰ï¼š

| ç±»å‹åç§°              | ä¸­æ–‡è¯‘å          | æè¿°                                      |
| --------------------- | ----------------- | ----------------------------------------- |
| `IfStatement`         | `If` æ§åˆ¶æµè¯­å¥   | é€šå¸¸æŒ‡ `if (true) {} else {}`             |
| `ForInStatement`      | `For-in` å¾ªç¯è¯­å¥ | é€šå¸¸æŒ‡ `for(let key in obj) {}`           |
| `SwitchStatement`     | `Switch` è¯­å¥     | é€šå¸¸æŒ‡ `switch`                           |
| `WhileStatement`      | `While` å¾ªç¯è¯­å¥  | é€šå¸¸æŒ‡ `while(true) {}`                   |
| `ForStatement`        | `For` å¾ªç¯è¯­å¥    | é€šå¸¸æŒ‡ `for(let i = 0; i < 10; i++) {}`   |
| `BreakStatement`      | ä¸­æ–­è¯­å¥          | é€šå¸¸æŒ‡ `break`                            |
| `ContinueStatement`   | æŒç»­è¯­å¥          | é€šå¸¸æŒ‡ `continue`                         |
| `ReturnStatement`     | è¿”å›è¯­å¥          | é€šå¸¸æŒ‡ `return`                           |
| `BlockStatement`      | å—è¯­å¥            | åŒ…è£¹åœ¨ `{}` å†…çš„è¯­å¥                      |
| `ExpressionStatement` | è¡¨è¾¾å¼è¯­å¥        | é€šå¸¸ä¸ºè°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚ `console.log(1)` |

### 4.4. å£°æ˜ã€Œ[Declaration >>](https://www.babeljs.cn/docs/babel-types#declaration)ã€

å£°æ˜è¯­å¥æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¯­å¥ï¼Œå®ƒæ‰§è¡Œçš„é€»è¾‘æ˜¯åœ¨ä½œç”¨åŸŸå†…å£°æ˜ä¸€ä¸ª `å˜é‡`ã€å‡½æ•°ã€`class`ã€`import`ã€`export` ç­‰ã€‚

| ç±»å‹åç§°                   | ä¸­æ–‡è¯‘å         | æè¿°                              |
| -------------------------- | ---------------- | --------------------------------- |
| `VariableDeclaration`      | å˜é‡å£°æ˜         | `const a = 10;`                   |
| `FunctionDeclaration`      | å‡½æ•°å£°æ˜         | `function sum() {}`               |
| `ImportDeclaration`        | æ¨¡å—å¼•å…¥å£°æ˜     | `import { reactive } from 'vue;'` |
| `ExportDefaultDeclaration` | æ¨¡å—é»˜è®¤å¯¼å‡ºå£°æ˜ | `export default a = 10;`          |

### 4.5. è¡¨è¾¾å¼ã€Œ[Expression >>](https://www.babeljs.cn/docs/babel-types#expression)ã€

è¡¨è¾¾å¼çš„ç‰¹ç‚¹æ˜¯æ‰§è¡Œå®Œä»¥åæœ‰è¿”å›å€¼ï¼Œè¿™æ˜¯å’Œè¯­å¥ (`statement`) çš„åŒºåˆ«

| ç±»å‹åç§°                  | ä¸­æ–‡è¯‘å       | æè¿°                               |
| ------------------------- | -------------- | ---------------------------------- |
| `ArrayExpression`         | æ•°ç»„è¡¨è¾¾å¼     | é€šå¸¸æŒ‡ä¸€ä¸ªæ•°ç»„ï¼š`[1, 2, 3]`        |
| `ArrowFunctionExpression` | ç®­å¤´å‡½æ•°è¡¨è¾¾å¼ | `() => {}`                         |
| `AssignmentExpression`    | èµ‹å€¼è¡¨è¾¾å¼     | é€šå¸¸æŒ‡ä¸ºä¸€ä¸ªå˜é‡èµ‹å€¼ï¼Œæ¯”å¦‚ `a = 1` |
| `BinaryExpression`        | äºŒå…ƒè¡¨è¾¾å¼     | `1 + 2`                            |
| `UnaryExpression`         | ä¸€å…ƒè¡¨è¾¾å¼     | `-1`                               |
| `FunctionExpression`      | å‡½æ•°è¡¨è¾¾å¼     | `function(){}`                     |

### 4.6. `Comment` & `Program`

| ç±»å‹åç§°       | ä¸­æ–‡è¯‘å | æè¿°             |
| -------------- | -------- | ---------------- |
| `Program`      | ç¨‹åºä¸»ä½“ | æ•´æ®µä»£ç çš„ä¸»ä½“   |
| `CommentBlock` | å—çº§æ³¨é‡Š | `/* å—çº§æ³¨é‡Š */` |
| `CommentLine`  | å•è¡Œæ³¨é‡Š | `// å•è¡Œæ³¨é‡Š`    |

# ä¸‰ã€å·¥ä½œåŸç†

![](./IMGS/babel.png)

Babel çš„ç¼–è¯‘è¿‡ç¨‹å’Œå¤§å¤šæ•°å…¶ä»–è¯­è¨€çš„ç¼–è¯‘å™¨å¤§è‡´ç›¸åŒï¼Œå¯ä»¥åˆ†ä¸º **ä¸‰ä¸ªé˜¶æ®µ**ï¼š

ğŸ“Œï¼š`è§£æ(Parse)`  â†’  `è½¬æ¢(Transform)`  â†’  `ç”Ÿæˆ(Generate)`ã€‚

## 1. è§£æã€ŒParserã€

å°†ä»£ç å­—ç¬¦ä¸²è§£ææˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œæ¯ä¸ª JavaScript å¼•æ“ï¼ˆæ¯”å¦‚Chromeæµè§ˆå™¨ä¸­çš„ `V8` å¼•æ“ï¼‰éƒ½æœ‰è‡ªå·±çš„ASTè§£æå™¨ï¼Œè€ŒBabelæ˜¯é€šè¿‡ [@babel/parser >>](https://www.babeljs.cn/docs/babel-parser) å®ç°çš„ã€‚è§£æè¿‡ç¨‹æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š**è¯æ³•åˆ†æ** å’Œ **è¯­æ³•åˆ†æ**ï¼Œè¯æ³•åˆ†æé˜¶æ®µæŠŠå­—ç¬¦ä¸²å½¢å¼çš„ä»£ç è½¬æ¢ä¸º**ä»¤ç‰Œ**ï¼ˆtokensï¼‰æµï¼Œä»¤ç‰Œç±»ä¼¼äºASTä¸­èŠ‚ç‚¹ï¼›è€Œè¯­æ³•åˆ†æé˜¶æ®µåˆ™ä¼šæŠŠä¸€ä¸ªä»¤ç‰Œæµè½¬æ¢æˆ ASTçš„å½¢å¼ï¼ŒåŒæ—¶è¿™ä¸ªé˜¶æ®µä¼šæŠŠä»¤ç‰Œä¸­çš„ä¿¡æ¯è½¬æ¢æˆASTçš„è¡¨è¿°ç»“æ„ã€‚

## 2. è½¬æ¢ã€ŒTransformã€

å¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œè½¬æ¢æ“ä½œï¼Œè½¬æ¢æ­¥éª¤æ¥æ”¶ AST å¹¶å¯¹å…¶è¿›è¡Œéå†ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€æ›´æ–°åŠç§»é™¤ç­‰æ“ä½œã€‚ Babelé€šè¿‡ [@babel/traverse](https://www.babeljs.cn/docs/babel-traverse) å¯¹å…¶è¿›è¡Œ **æ·±åº¦ä¼˜å…ˆéå†**ï¼Œç»´æŠ¤ASTæ ‘çš„æ•´ä½“çŠ¶æ€ï¼Œå¹¶ä¸”å¯å®Œæˆå¯¹å…¶çš„æ›¿æ¢ï¼Œåˆ é™¤æˆ–è€…å¢åŠ èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ–¹æ³•çš„å‚æ•°ä¸ºåŸå§‹ASTå’Œè‡ªå®šä¹‰çš„è½¬æ¢è§„åˆ™ï¼Œè¿”å›ç»“æœä¸ºè½¬æ¢åçš„ASTã€‚

## 3. ç”Ÿæˆã€ŒGeneratorã€

æ ¹æ®å˜æ¢åçš„æŠ½è±¡è¯­æ³•æ ‘å†ç”Ÿæˆä»£ç å­—ç¬¦ä¸²ï¼ŒåŒæ—¶è¿˜ä¼šåˆ›å»º [æºç æ˜ å°„ï¼ˆ`source maps`ï¼‰](https://www.html5rocks.com/en/tutorials/developertools/sourcemaps/)

ä»£ç ç”Ÿæˆå…¶å®å¾ˆç®€å•ï¼šæ·±åº¦ä¼˜å…ˆéå†æ•´ä¸ª ASTï¼Œç„¶åæ„å»ºå¯ä»¥è¡¨ç¤ºè½¬æ¢åä»£ç çš„å­—ç¬¦ä¸²ã€‚

Babel é€šè¿‡ [@babel/generator](https://www.babeljs.cn/docs/babel-generator)  å°†ASTè½¬æ¢æˆjsä»£ç ï¼Œè¿‡ç¨‹å°±æ˜¯æ·±åº¦ä¼˜å…ˆéå†æ•´ä¸ªASTï¼Œç„¶åæ„å»ºå¯ä»¥è¡¨ç¤ºè½¬æ¢åä»£ç çš„å­—ç¬¦ä¸²ã€‚

# å››ã€Babel APIs

æˆ‘ä»¬çŸ¥é“ Babel çš„ç¼–è¯‘æµç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š`Parse` â†’ `Transform` â†’ `Generate`ï¼Œæ¯ä¸€æ­¥éƒ½æš´éœ²äº†ä¸€äº› Api å‡ºæ¥ï¼š

- **è§£æé˜¶æ®µ**ï¼šé€šè¿‡ `@babel/parser` å°†æºç è½¬æˆ ASTï¼›
- **è½¬æ¢é˜¶æ®µ**ï¼šé€šè¿‡ `@babel/traverse` éå†ASTï¼Œå¹¶è°ƒç”¨ `visitor` å‡½æ•°ä¿®æ”¹ ASTï¼ŒæœŸé—´æ¶‰åŠåˆ° AST çš„åˆ¤æ–­ã€åˆ›å»ºã€ä¿®æ”¹ç­‰ï¼Œè¿™æ—¶å€™å°±éœ€è¦ `@babel/types` äº†ï¼Œå½“éœ€è¦æ‰¹é‡åˆ›å»º AST çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ `@babel/template` æ¥ç®€åŒ– AST åˆ›å»ºé€»è¾‘ï¼›
- **ç”Ÿæˆé˜¶æ®µ**ï¼šé€šè¿‡ `@babel/generate` å°† AST è¾“å‡ºä¸ºç›®æ ‡ä»£ç å­—ç¬¦ä¸²ï¼ŒåŒæ—¶ç”Ÿæˆ `sourcemap`ï¼›
- ä¸­é€”é‡åˆ°é”™è¯¯æƒ³æ‰“å°ä»£ç ä½ç½®çš„æ—¶å€™ï¼Œä½¿ç”¨ `@babel/code-frame` åŒ…
- Babel çš„æ•´ä½“åŠŸèƒ½é€šè¿‡ `@babel/core` æä¾›ï¼ŒåŸºäºä¸Šé¢çš„åŒ…å®Œæˆ Babel æ•´ä½“çš„ç¼–è¯‘æµç¨‹ï¼Œå¹¶å®ç°æ’ä»¶åŠŸèƒ½ã€‚

## 1. [`@babel/parser`](https://www.babeljs.cn/docs/babel-parser)

`@babel/parser` ï¼ˆä¹‹å‰å« `Babylon`ï¼‰æ˜¯åŸºäº `acorn` å®ç°çš„ï¼Œæ‰©å±•äº†å¾ˆå¤šè¯­æ³•ï¼Œå¯ä»¥æ”¯æŒ `ESNext`ã€`JSX`ã€`Flow`ã€`Typescript` ç­‰è¯­æ³•çš„è§£æï¼Œå…¶ä¸­ `JSX`ã€`Flow`ã€`Typescript`  è¿™äº›éæ ‡å‡†çš„è¯­æ³•çš„è§£æéœ€è¦æŒ‡å®šè¯­æ³•æ’ä»¶ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

```javascript
// â†’ å¯¼å…¥æ¨¡å—
const parser = require('@babel/parser');

// â†’ å®šä¹‰ä¸€æ®µä»£ç å­—ç¬¦ä¸²
const codeString = `function square(n) {
  return n * n;
}`;

// â†’ è§£æä»£ç å­—ç¬¦ä¸²
const ast = parser.parse(codeString, {
  sourceType: 'script', // module unambigious
  plugins: ['jsx', 'typescript'],
});

// â†’ è¾“å‡ºast
console.log(JSON.stringify(ast, null, 4));
```

## 2. [`@babel/traverse`](https://www.babeljs.cn/docs/babel-traverse)

éå† ASTï¼Œå¹¶åœ¨éå†è¿‡ç¨‹ä¸­å¯¹ AST èŠ‚ç‚¹è¿›è¡Œå¢åˆ æ”¹ã€‚éå†ä¸€ä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹æ˜¯ï¼š`Enter` â†’ `Traverse child node` â†’ `Exit`

è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š

```javascript
require("@babel/traverse").default(ast, visitors)
```

- `ast`ï¼šæŠ½è±¡è¯­æ³•æ ‘AST
- `visitors`ï¼šè®¿é—®è€…

ç¤ºä¾‹ä»£ç ï¼š

```javascript
require("@babel/traverse").default(ast, {
  /** - 1.è¿›å…¥èŠ‚ç‚¹æ—¶è°ƒç”¨ï¼ˆä¸€èˆ¬ä¸ç”¨ï¼‰ */
  enter(path) {
    console.log('__enter__');
  },
  /** - 2.ç¦»å¼€èŠ‚ç‚¹æ—¶è°ƒç”¨ï¼ˆä¸€èˆ¬ä¸ç”¨ï¼‰ */
  exit(path) {
    console.log('__exit__');
  },
  /** - 3.å½“éå†åˆ°æŒ‡å®šèŠ‚ç‚¹ç±»å‹æ—¶è°ƒç”¨ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ï¼šFunctionDeclarationï¼ˆå‡½æ•°å£°æ˜ï¼‰ï¼ˆå»ºè®®æ–¹æ¡ˆï¼‰ */
  FunctionDeclaration(path) {
    console.log('__FunctionDeclaration__');
  },
  /** - 4.ä½ å¯ä»¥å•ç‹¬ç›‘å¬æŸä¸ªèŠ‚ç‚¹ç±»å‹çš„è¿›å…¥æˆ–è€…ç¦»å¼€ */
  FunctionDeclaration: {
    enter(path) {
      console.log('__FunctionDeclaration_enter_');
    },
    exit(path) {
      console.log('__FunctionDeclaration_exit_');
    },
  },
  /** - 5.å½“éå†åˆ° FunctionDeclaration|ReturnStatement èŠ‚ç‚¹æ—¶è°ƒç”¨ï¼ˆè¿™ç§æ–¹å¼ä¼šè¦†ç›–å‰é¢å‡ ç§æ–¹å¼ï¼‰ */
  ['FunctionDeclaration|ReturnStatement'](path) {
    console.log('__FunctionDeclaration|ReturnStatement');
  },
});
```

> **æç¤º**ï¼šä¸€èˆ¬æ¥è¯´ä¸æ¨èä½¿ç”¨å…¨å±€è§¦å‘ï¼Œå°½é‡ä»¥ **ç²¾ç¡®çš„æ–¹å¼å®šä½** åˆ°èŠ‚ç‚¹ã€‚

å‚æ•° `path`ï¼šè¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´ **è¿æ¥** çš„ **å¯¹è±¡**ï¼ŒåŒ…å«å…³äºè·¯å¾„æ“ä½œå’Œè·¯å¾„ç›¸å…³çš„ä¿¡æ¯ï¼ˆ *åç»­åœ¨æ’ä»¶å¼€å‘å°èŠ‚ç»†è¯´* ï¼‰

## 3. [`@babel/types`](https://www.babeljs.cn/docs/babel-types)

ä¸»è¦ç”¨æ¥æ“ä½œASTèŠ‚ç‚¹ï¼Œæ¯”å¦‚åˆ›å»ºã€æ ¡éªŒã€è½¬å˜ç­‰ã€‚æ¯”å¦‚è¿™é‡Œå°†åˆšåˆšç¤ºä¾‹å‡½æ•°é‡Œé¢çš„æ ‡å¿—ç¬¦ `n` å˜æˆ `x`ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```javascript
// â†’ å¯¼å…¥æ¨¡å—
const parser = require('@babel/parser');
const traverse = require('@babel/traverse');
const t = require('@babel/types');

// â†’ å®šä¹‰ä¸€æ®µä»£ç å­—ç¬¦ä¸²
const codeString = `function square(n) {
  return n * n;
}`;

// â†’ è§£æä»£ç å­—ç¬¦ä¸²
const ast = parser.parse(codeString, {
  sourceType: 'script', // module unambigious
  plugins: ['jsx', 'typescript'],
});

// â†’ éå†èŠ‚ç‚¹
traverse.default(ast, {
  Identifier(path) {
    // åˆ¤æ–­æ˜¯å¦æ˜¯ name ä¸º n çš„æ ‡å¿—ç¬¦
    if (t.isIdentifier(path.node, { name: 'n' })) {
      path.node.name = 'x';
    }
  },
});

// â†’ è¾“å‡ºast
console.log(JSON.stringify(ast, null, 4));
```

> **æç¤º**ï¼šå…³äº `@babel/types` çš„æ›´å¤šç”¨æ³•è¯·å‚è€ƒ API.

## 4. [`@babel/generator`](https://www.babeljs.cn/docs/babel-generator)

å½“æˆ‘ä»¬å¯¹ASTè¿›è¡Œéå†æ“ä½œä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ `@babel/generator` å°† AST ç”Ÿæˆç›®æ ‡ä»£ç äº†ï¼Œå…·ä½“ä½¿ç”¨å¦‚ä¸‹ï¼š

```javascript
const generator = require('@babel/generator');

// ...

// â†’ å°†ASTè¾“å‡ºä¸ºç›®æ ‡ä»£ç 
const code = generator.default(ast).code;
console.log(code);
/**
 * â†’ è¾“å‡ºç»“æœ
 * function square(x) {
 *    return x * x;
 * }
 */
```

## 5. [`@babel/core`](https://www.babeljs.cn/docs/babel-core)

`@babel/core` åŒ…åŸºäºå‰é¢çš„åŒ…å®Œæˆæ•´ä¸ªç¼–è¯‘æµç¨‹ï¼Œä»æºç åˆ°ç›®æ ‡ä»£ç ï¼Œç”Ÿæˆ `sourcemap`ï¼Œå…¶è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š

```javascript
// â†’ åŒæ­¥æ–¹æ³•
transformSync(code, options); // => { code, map, ast }
transformFileSync(filename, options); // => { code, map, ast }
transformFromAstSync(parsedAst, sourceCode, options); // => { code, map, ast }
// â†’ å¼‚æ­¥æ–¹æ³•
transformAsync('code();', options).then((result) => {});
transformFileAsync('filename.js', options).then((result) => {});
transformFromAstAsync(parsedAst, sourceCode, options).then((result) => {});
```

# äº”ã€åˆæ¢

## 1. åˆ›å»ºç›®å½•

åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„é¡¹ç›®æ–‡ä»¶ç»“æ„ï¼Œå¹¶æ–°å»ºå¿…è¦æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
$ mkdir -p hello-babel/src && cd hello-babel && touch src/app.js
```

> æ³¨æ„ï¼š` package.json` æ–‡ä»¶é€šè¿‡ `npm init -y` æŒ‡ä»¤è‡ªåŠ¨ç”Ÿæˆã€‚

## 2. å®‰è£…ä¾èµ–

```shell
$ npm init -y
$ npm install --save-dev @babel/core @babel/cli @babel/preset-env
```

## 3. é…ç½®æ–‡ä»¶

å¯ä»¥é€šè¿‡å‡ ç§ä¸åŒçš„æ–¹å¼æ¥ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼š

- `babel.config.json`ï¼šv7.8.0ä»¥ä¸Šï¼ˆå»ºè®®ä½¿ç”¨ï¼‰
- `babel.config.js`ï¼šæ—§ç‰ˆæœ¬
- `.babelrc`
- `package.json['babel']`

> **å¸¸ç”¨Optionså­—æ®µè¯´æ˜**

- `env`ï¼šå®šåœ¨ä¸åŒç¯å¢ƒä¸‹ä½¿ç”¨çš„é…ç½®ã€‚
- `plugins`ï¼šåŠ è½½å’Œä½¿ç”¨çš„æ’ä»¶åˆ—è¡¨ï¼Œæ’ä»¶åå‰çš„babel-plugin-å¯çœç•¥ï¼›pluginåˆ—è¡¨æŒ‰ä»å¤´åˆ°å°¾çš„é¡ºåºè¿è¡Œã€‚
- `presets`ï¼šè¦åŠ è½½å’Œä½¿ç”¨çš„presetåˆ—è¡¨ï¼Œpresetåå‰çš„babel-preset-å¯çœç•¥ï¼›presetsåˆ—è¡¨çš„presetæŒ‰ä»å°¾åˆ°å¤´çš„**é€†åº**è¿è¡Œï¼ˆä¸ºäº†å…¼å®¹ç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯ï¼‰

> **é…ç½®æ–‡ä»¶çš„æŸ¥æ‰¾**

Babel ä¼šä»å½“å‰è½¬è¯‘çš„æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸‹æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±é¡ºç€æ–‡æ¡£ç›®å½•æ ‘ä¸€å±‚å±‚å¾€ä¸ŠæŸ¥æ‰¾ï¼Œä¸€ç›´åˆ° `.babelrc` æ–‡ä»¶å­˜åœ¨æˆ–è€…å¸¦ `babel` å­—æ®µçš„ `package.json` æ–‡ä»¶å­˜åœ¨ä¸ºæ­¢ã€‚

æ¥ä¸‹æ¥ï¼Œåœ¨æ ¹ç›®å½•ä¸­åˆ›å»º `babel.config.json` é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ°æ­¤æ–‡ä»¶ä¸­ï¼š

```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "browsers": ["last 2 versions", "safari >= 7"]
        },
        "useBuiltIns": "usage",
        "corejs": "3.6.5"
      }
    ]
  ]
}
```

> ä¸Šè¿°æµè§ˆå™¨åˆ—è¡¨ï¼ˆ`browsers`ï¼‰ä»…ç”¨äºç¤ºä¾‹ã€‚è¯·æ ¹æ®ä½ æ‰€éœ€è¦æ”¯æŒçš„æµè§ˆå™¨è¿›è¡Œè°ƒæ•´ã€‚å‚è§ [æ­¤å¤„](https://www.babeljs.cn/docs/babel-preset-env) ä»¥äº†è§£ `@babel/preset-env` å¯æ¥å—å“ªäº›å‚æ•°ã€‚

## 4. åŸºæœ¬ä½¿ç”¨

é€šè¿‡ä¸Šé¢çš„å‡†å¤‡å·¥ä½œï¼Œæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥ä½¿ç”¨ Babel è¿›è¡Œç¼–è¯‘è½¬æ¢äº†ã€‚åœ¨ `/src/app.js` æ–‡ä»¶ä¸­å†™ä¸€ä¸ªes6çš„ç®­å¤´å‡½æ•°

```javascript
(function () {
  const hello = (name) => {
    console.log(`Hello, ${name}!`);
  };
  hello('Babel');
})();
```

ç„¶åä½¿ç”¨Babelå‘½ä»¤è¡Œå·¥å…·è¿›è¡Œç¼–è¯‘

```shell
# -- ç¼–è¯‘æ–‡ä»¶
$ ./node_modules/.bin/babel src/app.js --out-file lib/app.js -w -s
# -- ç¼–è¯‘ç›®å½•
$ ./node_modules/.bin/babel src --out-dir lib -w -s
```

è§£è¯»ï¼š

- `-o`ï¼šå°†æŸä¸ªjsæ–‡ä»¶ç¼–è¯‘æˆæŒ‡å®šjsæ–‡ä»¶

- `-d`ï¼šå°†æŸä¸ªç›®å½•ä¸‹çš„jsæ–‡ä»¶ç¼–è¯‘è‡³æŒ‡å®šç›®å½•

- `-w`ï¼šå®æ—¶ç›‘å¬æ–‡ä»¶/è‡ªåŠ¨ç¼–è¯‘

- `-s`ï¼šç”Ÿæˆèµ„æºæ˜ å°„æ–‡ä»¶ä¾¿äºè°ƒè¯•ï¼Œå®ƒå¯ä»¥å¸®åŠ©ä½ åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆç›®å‰åªæœ‰google chromeæµè§ˆå™¨æ”¯æŒè¯¥åŠŸèƒ½ï¼‰çš„â€œSourceâ€é€‰é¡¹å¡ä¸­æ‰¾åˆ°ç¼–è¯‘å‰çš„æºæ–‡ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…è¿›è¡Œè°ƒè¯•ã€‚

  ä½†é¦–å…ˆå¾—ç¡®ä¿ä½ å¼€å‘è€…å·¥å…·çš„è®¾ç½®é‡Œçš„è¿™ä¸€é¡¹æ˜¯å¤„äºå‹¾é€‰çŠ¶æ€ï¼š`å³é”®æ£€æŸ¥` â†’ `å·¥å…·æ ä¸­é€‰æ‹©æ›´å¤š(å³ä¸Šè§’ä¸‰ä¸ªç«–ç€çš„å°åœ†ç‚¹)` â†’  `Setting` â†’  `Sources` â†’  `Enable JavaScript source maps.`

ç»è¿‡ç¼–è¯‘åç”Ÿæˆçš„ `lib/app.js` æ˜¯è¿™æ ·çš„ï¼š

```javascript
(function () {
  var hello = function hello(name) {
    console.log("Hello, ".concat(name, "!"));
  };

  hello('Babel');
})();
```

## 5. Npm scripts

åœ¨ `package.json`  æ–‡ä»¶çš„ `scripts` å±æ€§ä¸‹ï¼Œè®¾ç½®å¦‚ä¸‹ä»£ç ï¼š

```json
"scripts": {
  "dev": "./node_modules/.bin/babel src --out-dir lib -w -s"
},
```

> æç¤ºï¼š`dev` è¿™ä¸ªå±æ€§åæ˜¯è‡ªå®šä¹‰çš„ï¼Œå…¶å±æ€§å€¼åˆ™æ˜¯è¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚

å†…å®¹é…ç½®å®Œæˆä¹‹åï¼Œåˆ‡æ¢åˆ°å‘½ä»¤è¡Œçª—å£è¾“å…¥ï¼š

 ```shell
$ npm run dev
 ```

è¿™æ ·å³å¯æ‰§è¡ŒæŒ‡ä»¤è¿›è¡Œç¼–è¯‘ã€‚

# å…­ã€æ’ä»¶å¼€å‘åŸºç¡€

## 1. è¯­æ³•ç»“æ„

Babel æ’ä»¶ä¸»è¦åº”ç”¨åœ¨è½¬æ¢ï¼ˆ`Transform`ï¼‰é˜¶æ®µï¼Œå…¶æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ŒåŸºæœ¬çš„è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š

```javascript
module.exports = ({ types: t }) => ({
  /** æ’ä»¶åç§° */
  name: 'babel-plugin-name',
  /** è®¿é—®è€…ï¼Œæ’ä»¶æ ¸å¿ƒä»£ç ä¸»è¦åœ¨è¿™é‡Œç¼–è¾‘ */
  visitor: {
    // â†’ è®¿é—®æŒ‡å®šèŠ‚ç‚¹ç±»å‹æ—¶è§¦å‘çš„é’©å­ï¼Œè¿™é‡Œæ˜¯ Identifier ç±»å‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä»»æ„èŠ‚ç‚¹ç±»å‹
    Identifier(path, state) {
      // coding in here...
    },
  },
});
```

ç»“æ„è§£è¯»ï¼š

- `types`ï¼š[@babel/types >>](https://babel.docschina.org/docs/en/babel-types/) å·¥å…·åº“ï¼Œä¸»è¦ç”¨æ¥æ“ä½œASTèŠ‚ç‚¹ï¼Œæ¯”å¦‚åˆ›å»ºã€æ ¡éªŒã€è½¬å˜ç­‰ã€‚
- `name`ï¼šæ’ä»¶åç§°ã€‚
- `visitor`ï¼šBabel é‡‡å–é€’å½’çš„æ–¹å¼è®¿é—®ASTçš„æ¯ä¸ªèŠ‚ç‚¹ã€‚
- `Identifier`ï¼šæ ‡è¯†ç¬¦ï¼ŒèŠ‚ç‚¹ç±»å‹ï¼Œå½“éå†åˆ°ç±»å‹ä¸º `Identifier` æ—¶è¯¥å‡½æ•°ä¼šè¢«è§¦å‘ã€‚
- `path`ï¼šè·¯å¾„ï¼ŒèŠ‚ç‚¹ä¹‹é—´è¿æ¥å¯¹è±¡ï¼ŒåŒ…å«æ“ä½œèŠ‚ç‚¹çš„ä¸€äº›åˆ—å±æ€§å’Œæ–¹æ³•ã€‚
- `state`ï¼šçŠ¶æ€ï¼Œä½ å¯ä»¥é€šè¿‡ `state` è®¿é—®æ’ä»¶çš„é…ç½®é¡¹ã€‚

## 2. `Visitors`ï¼ˆè®¿é—®è€…ï¼‰

å½“æˆ‘ä»¬è°ˆåŠ **è¿›å…¥** ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®é™…ä¸Šæ˜¯è¯´æˆ‘ä»¬åœ¨ **è®¿é—®** å®ƒä»¬ï¼Œ ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™æ ·çš„æœ¯è¯­æ˜¯å› ä¸ºæœ‰ä¸€ä¸ª [**è®¿é—®è€…æ¨¡å¼ï¼ˆVisitorï¼‰>>**](https://en.wikipedia.org/wiki/Visitor_pattern) çš„æ¦‚å¿µã€‚

è®¿é—®è€…æ˜¯ä¸€ä¸ªç”¨äº AST éå†çš„è·¨è¯­è¨€çš„æ¨¡å¼ã€‚ ç®€å•çš„è¯´å®ƒä»¬å°±æ˜¯ä¸€ä¸ª **å¯¹è±¡**ï¼Œå®šä¹‰äº†ç”¨äºåœ¨ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ä¸­è·å–å…·ä½“èŠ‚ç‚¹çš„æ–¹æ³•ã€‚ è¿™ä¹ˆè¯´æœ‰äº›æŠ½è±¡æ‰€ä»¥è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚

```javascript
const visitor = {
  Identifier(path) {
    console.log('Called!');
  },
};
traverse.default(ast, visitor);
```

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„è®¿é—®è€…ï¼ŒæŠŠå®ƒç”¨äºéå†ä¸­æ—¶ï¼Œæ¯å½“åœ¨æ ‘ä¸­é‡è§ä¸€ä¸ª `Identifier` çš„æ—¶å€™ä¼šè°ƒç”¨ `Identifier()` æ–¹æ³•ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸€æ®µä»£ç ã€‚

```javascript
function square(n) {
  return n * n;
}
```

è§‚å¯Ÿå…¶ASTç»“æ„ï¼Œ`Identifier` ç±»å‹çš„èŠ‚ç‚¹æœ‰4ä¸ªï¼š

![](./IMGS/ast_visitor.png)

æ‰€ä»¥  `Identifier()` æ–¹æ³•ä¼šè¢«è°ƒç”¨å››æ¬¡ï¼š


```
Called!
Called!
Called!
Called!
```

## 3. `Path`ï¼ˆè·¯å¾„ï¼‰

AST é€šå¸¸ä¼šæœ‰è®¸å¤šèŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `path` å¯¹è±¡è¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œæ‰€ä»¥ï¼Œ`path` æ˜¯è¡¨ç¤ºä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿æ¥çš„ **å¯¹è±¡**ã€‚é€šè¿‡è¿™ä¸ªå¯¹è±¡æä¾›çš„å±æ€§æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ æ“ä½œ AST è¯­æ³•æ ‘ã€‚

![](./IMGS/babel_path.png)

ä¸Šå›¾ä¸­çº¢è‰²æ–¹æ¡†å¤„è¡¨ç¤ºå¯¹åº”èŠ‚ç‚¹çš„ path ç±»å‹ã€‚

### 2.1. å±æ€§

- `path.state`ï¼šBabel æ’ä»¶ä¿¡æ¯ï¼Œå¯é€šè¿‡ `state.opts` è·å–ä¼ å…¥çš„ Optionsï¼›
- `path.node`ï¼šå½“å‰éå†åˆ°çš„ node èŠ‚ç‚¹ï¼Œå¯é€šè¿‡å®ƒè®¿é—®èŠ‚ç‚¹ä¸Šçš„å±æ€§ï¼Œå¯¹äº Ast èŠ‚ç‚¹ï¼›
- `path.parent`ï¼šçˆ¶çº§ nodeï¼Œæ— æ³•è¿›è¡Œæ›¿æ¢ï¼›
- `path.parentPath`ï¼šçˆ¶çº§ pathï¼Œå¯è¿›è¡Œæ›¿æ¢ï¼›
- `path.scope`ï¼šä½œç”¨åŸŸç›¸å…³ï¼Œå¯ç”¨äºå˜é‡é‡å‘½åï¼Œå˜é‡ç»‘å®šå…³ç³»æ£€æµ‹ç­‰ï¼›
- `path.key`ï¼šè·å–è·¯å¾„æ‰€åœ¨å®¹å™¨çš„ç´¢å¼•
- `path.listKey`ï¼šè·å–å®¹å™¨çš„ `key`
- `path.container`ï¼šè·å–è·¯å¾„çš„å®¹å™¨ï¼ˆåŒ…å«æ‰€æœ‰åŒçº§èŠ‚ç‚¹çš„æ•°ç»„ï¼‰
- `path.inList`ï¼šåˆ¤æ–­è·¯å¾„æ˜¯å¦æœ‰åŒçº§èŠ‚ç‚¹

### 2.2. æ–¹æ³•

- `path.toString()`ï¼šå½“å‰è·¯å¾„æ‰€å¯¹åº”çš„æºä»£ç ï¼›
- `path.isXXX`ï¼š`XXX` ä¸ºèŠ‚ç‚¹ç±»å‹ï¼Œå¯ä»¥åˆ¤æ–­æ˜¯å¦ç¬¦åˆèŠ‚ç‚¹ç±»å‹ã€‚æ¯”å¦‚æˆ‘ä»¬éœ€è¦åˆ¤æ–­è·¯å¾„æ˜¯å¦ä¸º `StringLiteral` ç±»å‹ â†’ `path.isStringLiteral`ï¼›
- `path.get(key)`ï¼šè·å–å­èŠ‚ç‚¹ pathï¼Œä¾‹å¦‚ï¼š`path.get('body.0')` å¯ä»¥ç†è§£ä¸º `path.node.body[0]`è¿™æ ·çš„å½¢å¼ï¼Œè®©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿çš„æ‹¿åˆ°å­è·¯å¾„ï¼Œä½†æ˜¯æ³¨æ„ä»…è·¯å¾„å¯ä»¥è¿™æ ·æ“ä½œï¼Œè®¿é—®å±æ€§æ˜¯ä¸å…è®¸çš„ï¼
- `path.set(key)`ï¼šè®¾ç½®å­èŠ‚ç‚¹ path;
- `path.remove()`ï¼šåˆ é™¤ path;
- `path.replaceWith()`ï¼šç”¨ASTèŠ‚ç‚¹æ›¿æ¢è¯¥èŠ‚ç‚¹ï¼Œå¦‚ï¼š`path.replaceWith({ type: 'NumericLiteral', value: 3 })`ï¼Œåˆ›å»ºèŠ‚ç‚¹å¯ä»¥ä½¿ç”¨ `@babel/types`ï¼Œå¦‚æœæ˜¯å¤šè·¯å¾„åˆ™ä½¿ç”¨ `relaceWithMultiple([AST...])`;
- `path.replaceWidthSourceString()`ï¼š ç”¨å­—ç¬¦ä¸²æ›¿æ¢æºç 
- `path.find((path) => path.isObjectExpression())` ï¼šå‘ä¸‹æœå¯»èŠ‚ç‚¹
- `path.findParent()`ï¼šå‘çˆ¶èŠ‚ç‚¹æœå¯»èŠ‚ç‚¹
- `path.getSibling()`ã€`path.getNextSibling()`ã€`path.getPrevSibling()`ï¼š è·å–å…„å¼Ÿè·¯å¾„ï¼›
- `path.getFunctionParent()`ï¼š å‘ä¸Šè·å–æœ€è¿‘çš„ Function ç±»å‹èŠ‚ç‚¹ï¼›
- `path.getStatementParent()`ï¼š å‘ä¸Šè·å–æœ€è¿‘çš„ Statement ç±»å‹èŠ‚ç‚¹ï¼›
- `path.insertBefore()`ï¼šåœ¨ä¹‹å‰æ’å…¥å…„å¼ŸèŠ‚ç‚¹
- `path.insertAfter()`ï¼š åœ¨ä¹‹åæ’å…¥å…„å¼ŸèŠ‚ç‚¹
- `path.pushContainer()`ï¼š å°†AST pushåˆ°èŠ‚ç‚¹å±æ€§é‡Œé¢
- `path.traverse()`ï¼š é€’å½’çš„å½¢å¼æ¶ˆé™¤å…¨å±€çŠ¶æ€ï¼ˆ[å®˜ç½‘ >>](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md#toc-state) ä¾‹å­å·²ç»ä¸é”™äº†ï¼‰
- `path.stop()`ï¼š åœæ­¢éå†
- `path.skip()`ï¼š ä¸å¾€ä¸‹éå†ï¼Œè·³è¿‡è¯¥èŠ‚ç‚¹

## 4. `State`ï¼ˆçŠ¶æ€ï¼‰

[çŠ¶æ€ >>](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md#toc-state) æ˜¯æŠ½è±¡è¯­æ³•æ ‘ASTè½¬æ¢çš„æ•Œäººï¼ŒçŠ¶æ€ç®¡ç†ä¼šä¸æ–­ç‰µæ‰¯ä½ çš„ç²¾åŠ›ï¼Œè€Œä¸”å‡ ä¹æ‰€æœ‰ä½ å¯¹çŠ¶æ€çš„å‡è®¾ï¼Œæ€»æ˜¯ä¼šæœ‰ä¸€äº›æœªè€ƒè™‘åˆ°çš„è¯­æ³•æœ€ç»ˆè¯æ˜ä½ çš„å‡è®¾æ˜¯é”™è¯¯çš„ã€‚

è€ƒè™‘ä¸‹åˆ—ä»£ç ï¼š

```javascript
function square(n) {
  return n * n;
}
```

è®©æˆ‘ä»¬å†™ä¸€ä¸ªæŠŠ `n` é‡å‘½åä¸º `x` çš„è®¿é—®è€…çš„å¿«é€Ÿå®ç°.

```javascript
let paramName;
let visitor = {
  FunctionDeclaration(path) {
    const param = path.node.params[0];
    paramName = param.name;
    param.name = 'x';
  },

  Identifier(path) {
    if (path.node.name === paramName) {
      path.node.name = 'x';
    }
  },
}
```

å¯¹äºä¸‹é¢è¿™æ®µä»£ç ï¼š

```javascript
function square(n) {
  return n * n;
}
n;
```

ä¸Šé¢å®šä¹‰çš„è®¿é—®è€… `visitor` ä¹Ÿè®¸èƒ½å·¥ä½œï¼Œä½†å®ƒå¾ˆå®¹æ˜“è¢«æ‰“ç ´ï¼Œæ¯”å¦‚è¿™é‡Œè½¬æ¢ä¹‹åçš„ç»“æœæ˜¯ï¼š

```javascript
function square(n) {
  return n * n;
}
n;
```

å¯ä»¥çœ‹åˆ°ï¼Œå’Œå‡½æ•°åŒçº§åˆ«çš„ `n` ä¹Ÿè¢«è½¬æ¢æˆäº† `x`ï¼Œæ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯ä½¿ç”¨é€’å½’ï¼š

```javascript
const updateParamNameVisitor = {
  Identifier(path) {
    if (path.node.name === this.paramName) {
      path.node.name = 'x';
    }
  },
};
const visitor = {
  FunctionDeclaration(path) {
    const param = path.node.params[0];
    paramName = param.name;
    param.name = 'x';
    path.traverse(updateParamNameVisitor, { paramName });
  },
};
traverse.default(ast, visitor);
```

è¾“å‡ºç»“æœï¼š

```javascript
function square(x) {
  return x * x;
}

n;
```

è¾¾åˆ°é¢„æœŸï¼Œå½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªåˆ»æ„ç¼–å†™çš„ä¾‹å­ï¼Œä¸è¿‡å®ƒæ¼”ç¤ºäº†å¦‚ä½•ä»è®¿é—®è€…ä¸­æ¶ˆé™¤å…¨å±€çŠ¶æ€ã€‚

## 5. `Scope`ï¼ˆä½œç”¨åŸŸï¼‰

 `JavaScript` æ”¯æŒ [è¯æ³•ä½œç”¨åŸŸ ](https://en.wikipedia.org/wiki/Scope_(computer_science)#Lexical_scoping_vs._dynamic_scoping)ï¼Œå½“åˆ›å»ºå¼•ç”¨æ—¶ï¼Œä¸ç®¡æ˜¯é€šè¿‡å˜é‡ã€å‡½æ•°ã€ç±»å‹ã€å‚æ•°ã€æ¨¡å—å¯¼å…¥è¿˜æ˜¯æ ‡ç­¾ç­‰ï¼Œå®ƒéƒ½å±äºå½“å‰ä½œç”¨åŸŸã€‚

```javascript
// global scope
function scopeOne() {
  // scope 1
  function scopeTwo() {
    // scope 2
  }
}
```

1ï¼‰æ›´æ·±çš„å†…éƒ¨ä½œç”¨åŸŸä»£ç å¯ä»¥ä½¿ç”¨å¤–å±‚ä½œç”¨åŸŸä¸­çš„å¼•ç”¨ï¼Œæ¯”å¦‚åœ¨ `scope 2` ä¸­ï¼Œå¯ä»¥è®¿é—® `scope 1` å’Œ `global scope` é‡Œé¢çš„å¼•ç”¨ã€‚

2ï¼‰å†…å±‚ä½œç”¨åŸŸä¹Ÿå¯ä»¥åˆ›å»ºå’Œå¤–å±‚ä½œç”¨åŸŸåŒåçš„å¼•ç”¨ã€‚æ¯”å¦‚åœ¨ `scope 1` ä¸­å®šä¹‰äº†ä¸€ä¸ªå˜é‡ `a`ï¼Œåœ¨ `scope 2` ä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªåŒåçš„å˜é‡ `a`ã€‚

```javascript
function scopeOne() {
  const a = 1;
  const b = 2;
  function scopeTwo() {
    // â†’ è®¿é—®å¤–å±‚ä½œç”¨åŸŸé‡Œé¢çš„å˜é‡
    console.log(a);
    // â†’ åˆ›å»ºç›¸åŒåç§°çš„å˜é‡
    const b = 3;
  }
}
```

å½“ç¼–å†™ä¸€ä¸ªè½¬æ¢æ—¶ï¼Œå¿…é¡»å°å¿ƒä½œç”¨åŸŸã€‚æˆ‘ä»¬å¾—ç¡®ä¿åœ¨æ”¹å˜ä»£ç çš„å„ä¸ªéƒ¨åˆ†æ—¶ä¸ä¼šç ´åå·²ç»å­˜åœ¨çš„ä»£ç ã€‚

ä½œç”¨åŸŸå¯ä»¥è¢«è¡¨ç¤ºä¸ºå¦‚ä¸‹å½¢å¼ï¼š

```js
{
  path: NodePath,
  block: Node,
  parentBlock: Node,
  parent: Scope,
  bindings: { [name: string]: Binding }
}
```

**@Bindingsï¼ˆç»‘å®šï¼‰**

æ‰€æœ‰å¼•ç”¨å±äºç‰¹å®šçš„ä½œç”¨åŸŸï¼Œå¼•ç”¨å’Œä½œç”¨åŸŸçš„è¿™ç§å…³ç³»è¢«ç§°ä½œï¼š**ç»‘å®šï¼ˆbindingï¼‰**ï¼Œé€šè¿‡ `path.scope.bindings` å¯ä»¥æŸ¥çœ‹å˜é‡è¢«ç»‘å®šçš„æƒ…å†µã€‚

ç›¸å…³APIï¼š

- `path.scope.hasBinding("n")` ï¼šæ£€æŸ¥æœ¬åœ° `n` å˜é‡æ˜¯å¦è¢«ç»‘å®šï¼ˆå®šä¹‰ï¼‰ã€‚

- `path.scope.hasOwnBinding("n")` ï¼š æ£€æŸ¥è‡ªèº«ä½œç”¨åŸŸé‡Œé¢æœ‰æ²¡æœ‰ç»‘å®šï¼ˆå®šä¹‰ï¼‰è¿‡ `n` å˜é‡ã€‚

- `path.scope.generateUidIdentifier("uid")`: ç”Ÿæˆä¸€ä¸ªå½“å‰ä½œç”¨åŸŸä¸‹è‚¯å®šä¸å­˜åœ¨çš„å˜é‡åç§°ã€‚

- `path.scope.rename("n", "x")`ï¼šé‡å‘½åå˜é‡ã€‚

- `path.scope.parent.push`ï¼š(èŠ‚ç‚¹) åœ¨çˆ¶ä½œç”¨åŸŸé‡Œé¢æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹

## 7. æ’ä»¶å¼€å‘æµç¨‹ï¼ˆç¯å¢ƒï¼‰

é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸€ä¸ªæ’ä»¶çš„æ—¶å€™å¯ä»¥è¿™æ ·åšï¼š

1ï¼‰åˆ›å»ºå¿…è¦çš„é¡¹ç›®æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š

```shell
$ mkdir babel-plugin-xxx && cd babel-plugin-xxx && touch index.js && touch __test__.js
```

> - `index.js`ï¼šæ’ä»¶ä»£ç 
> - `__test__.js`ï¼šæµ‹è¯•ä»£ç 

2ï¼‰å®‰è£…ä¾èµ–

```shell
$ npm init -y && npm --save-dev install @babel/core @types/node
```

3ï¼‰ç¼–å†™æ’ä»¶åŸºç¡€ä»£ç 

```javascript
module.exports = ({ types: t }) => ({
  /** æ’ä»¶åç§° */
  name: 'babel-plugin-xxx',
  /** è®¿é—®è€… */
  visitor: {
    // coding in here...
  },
});
```

4ï¼‰ç¼–å†™æµ‹è¯•ä»£ç 

```javascript
// â†’ å¯¼å…¥ transformSync
const { transformSync } = require('@babel/core');

// â†’ ç¼–å†™æµ‹è¯•ä»£ç 
const code = `var a = 10;`;

// â†’ è°ƒç”¨æ’ä»¶å¤„ç†code
const output = transformSync(code, {
  plugins: ['./index.js'],
});

// â†’ è¾“å‡ºç›®æ ‡ä»£ç 
console.log(output.code);
```

4ï¼‰é€šè¿‡nodeè¿è¡Œ

```shell
$ node __test__.js 
```

> **ç‰¹åˆ«æç¤º**ï¼šåœ¨æ’ä»¶å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œä½ åº”è¯¥éšæ—¶æ‰“å¼€ [AST explorer >>](https://astexplorer.net/) æŸ¥çœ‹ä½ è¦å¤„ç†çš„æºä»£ç çš„ AST ç»“æ„ï¼Œè¿™æ ·ä¾¿äºä½ å¤„ç†æ’ä»¶ä¸­çš„é€»è¾‘ã€‚

# ä¸ƒã€æ’ä»¶å¼€å‘å®æˆ˜

## 1. babel-plugin-del-consolelogs

```js
module.exports = ({ types: t }) => {
  return {
    /** æ’ä»¶åç§° */
    name: 'babel-plugin-del-consolelogs',
    /** è®¿é—®è€… */
    visitor: {
      CallExpression(path) {
        // â†’ ç”Ÿäº§ç¯å¢ƒä¸‹æ‰å¤„ç†æ³¨é‡Šæ¸…é™¤
        if (process.env.NODE_ENV === 'production') {
          // â†’ è·å–çˆ¶çº§ASTèŠ‚ç‚¹
          const parentNode = path.parent;
          // â†’ ç­›é€‰æ˜¯å¦æ˜¯æ‰“å°è¯­å¥
          const isConsoleStatement = t.isIdentifier(path.node.callee.object, {
            name: 'console',
          });
          // â†’ å®šä¹‰å˜é‡ï¼Œè®°å½•æ˜¯å¦æ‰§è¡Œæ¸…é™¤åŠ¨ä½œï¼Œé»˜è®¤ä¸ºtrue
          let shouldRemove = true;
          // â†’ åˆ¤æ–­æ˜¯å¦æ˜¯conosleè¯­å¥
          if (isConsoleStatement) {
            // â†’ éå†å‰ç½®æ³¨é‡Š
            if (parentNode.leadingComments) {
              parentNode.leadingComments.forEach((comment) => {
                // åˆ¤æ–­æ³¨é‡Šå†…å®¹æ˜¯å¦æ˜¯ä¿ç•™æ³¨é‡Šï¼š@lg-noremove
                if (comment.value.trim() === '@lg-noremove') {
                  shouldRemove = false;
                }
              });
            }
            // â†’ éå†åç½®æ³¨é‡Š
            if (parentNode.trailingComments) {
              // è·å–consoleæ‰€åœ¨è¡Œ
              const consoleLine = parentNode.expression.loc.start.line;
              parentNode.trailingComments.forEach((comment) => {
                // è¯»å–æ³¨é‡Šæ‰€åœ¨è¡Œ
                const commentLine = comment.loc.start.line;
                // åˆ¤æ–­æ³¨é‡Šå†…å®¹æ˜¯å¦æ˜¯ä¿ç•™æ³¨é‡Šï¼š@lg-noremove å¹¶ä¸”æ˜¯å¦å’Œconsoleè¯­å¥åœ¨åŒä¸€è¡Œ
                if (
                  comment.value.trim() === '@lg-noremove' &&
                  consoleLine === commentLine
                ) {
                  shouldRemove = false;
                }
              });
            }
            // â†’ ç§»é™¤
            if (shouldRemove) {
              path.remove();
            }
          }
        }
      },
    },
  };
};
```